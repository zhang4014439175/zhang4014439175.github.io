<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>Java进阶-多线程并发 - 换个方向前进</title><meta name=keywords content="博客,程序员,架构师,思考,读书,笔记,技术,分享,大数据,产品"><meta name=author content="换个方向前进"><meta property="og:title" content="Java进阶-多线程并发"><meta property="og:site_name" content="换个方向前进"><meta property="og:image" content="https://zhang4014439175.github.ioimg/author.jpg"><meta name=title content="Java进阶-多线程并发 - 换个方向前进"><meta name=description content="Sample article showcasing basic String syntax."><link rel="shortcut icon" href=https://zhang4014439175.github.ioimg/favicon.ico><link rel=apple-touch-icon href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://zhang4014439175.github.iocss/main.css rel=stylesheet type=text/css><link href=https://zhang4014439175.github.iocss/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>换个方向前进</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>愿每个目标坚定的自己，都能在未来无惧内卷、自信昂扬!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>分类</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我的</a></li><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益网站</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://zhang4014439175.github.io/post/%E5%B9%B6%E5%8F%91/ itemprop=url>Java进阶-多线程并发</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22 content="2021-10-05">2021-10-05</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/java-advanced itemprop=url rel=index><span itemprop=name>Java-Advanced</span></a>
&nbsp;</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E5%B9%B6%E5%8F%91 itemprop=url rel=index><span itemprop=name>并发</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>10728 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>22分钟</span></span>
<span id=/post/%E5%B9%B6%E5%8F%91/ class="leancloud_visitors post-visitor" data-flag-title=Java进阶-多线程并发><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><p>        多线程并发是后端开发中常见问题，也是最难解决的问题，下功夫多研究研究，本文档是java juc 的学习笔记。</p><h1 id=一什么是-juc>一、什么是 JUC</h1><p><strong>1、进程和线程</strong></p><p><strong>进程</strong>是计算机中的程序关于某数据集合上的一次运行活动，是系 统进行资源分配和调度的基本单位，是操作系统结构的基础。 在当代面向线程 设计的计算机结构中，进程是线程的容器。程序是指令、数据及其组织形式的 描述，进程是程序的实体。是计算机中的程序关于某数据集合上的一次运行活 动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。程序是 指令、数据及其组织形式的描述，进程是程序的实体。</p><p><strong>线程</strong> 是操作系统能够进行运算调度的最小单位。它被包含在进程之 中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流， 一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p><p><strong>总结来说</strong></p><p><strong>进程</strong>：指在系统中正在运行的一个应用程序;程序一旦运行就是进程;进程— —资源分配的最小单位。</p><p><strong>线程</strong>：系统分配处理器时间资源的基本单元，或者说进程之内独立执行的一个 单元执行流。线程——程序执行的最小单位。</p><p><strong>1.1线程的状态</strong></p><p><strong>2、wait和sleep</strong></p><p>(1)sleep 是 Thread 的静态方法，wait 是 Object 的方法，任何对象实例都 能调用。</p><p>(2)sleep 不会释放锁，它也不需要占用锁。wait 会释放锁，但调用它的前提 是当前线程占有锁(即代码要在 synchronized 中)。</p><p>(3)它们都可以被 interrupted 方法中断。</p><p><strong>3、并行和串行</strong></p><p>**串行：**表示所有任务都一一按先后顺序进行。串行意味着必须先装完一车柴才能
运送这车柴，只有运送到了，才能卸下这车柴，并且只有完成了这整个三个步
骤，才能进行下一个步骤。串行是一次只能取得一个任务，并执行这个任务。</p><p>**并行：**意味着可以同时取得多个任务，并同时去执行所取得的这些任务。并行模
式相当于将长长的一条队列，划分成了多条短队列，所以并行缩短了任务队列
的长度。并行的效率从代码层次上强依赖于多进程/多线程代码，从硬件角度上 则依赖于多核 CPU。</p><p><strong>并发(concurrent)</strong>：指的是多个程序可以同时运行的现象，更细化的是多进程可 以同时运行或者多指令可以同时运行。但这不是重点，在描述并发的时候也不 会去扣这种字眼是否精确，==并发的重点在于它是一种现象==, ==并发描述 的是多进程同时运行的现象==。但实际上，对于单核心 CPU 来说，同一时刻 只能运行一个线程。所以，这里的"同时运行"表示的不是真的同一时刻有多个 线程运行的现象，这是并行的概念，而是提供一种功能让用户看来多个程序同 时运行起来了，但实际上这些程序中的进程不是一直霸占 CPU 的，而是执行一 会停一会。</p><p>**管程(monitor)：**是保证了同一时刻只有一个进程在管程内活动,即管程内定义的操作在同 一时刻只被一个进程调用(由编译器实现).但是这样并不能保证进程以设计的顺序执行</p><p>JVM 中同步是基于进入和退出管程(monitor)对象实现的，每个对象都会有一个管程 (monitor)对象，管程(monitor)会随着 java 对象一同创建和销毁</p><p>执行线程首先要持有管程对象，然后才能执行方法，当方法完成之后会释放管程，方 法在执行时候会持有管程，其他线程无法再获取同一个管程</p><p><strong>用户线程和守护线程：</strong></p><p><strong>用户线程</strong>：平时用到的普通线程,自定义线程</p><p><strong>守护线程</strong>：运行在后台,是一种特殊的线程,比如垃圾回收</p><p>当主线程结束后,用户线程还在运行,JVM存活</p><p>如果没有用户线程,都是守护线程,JVM结束</p><p>isDaemon() 是否守护线程</p><p>setDaemon(true) 设置守护线程</p><h2 id=1线程的生命周期>1、线程的生命周期</h2><p>state枚举：新建、就绪、运行、阻塞、死亡</p><p>suspend挂起：已经过时了</p><p>sleep</p><p>join</p><h2 id=2同步的操作>2、同步的操作</h2><h3 id=1知识>1）知识</h3><p>共享数据：ticketnum就是共享数据</p><p>同步监视器：锁，任何一个类的对象，都可以充当锁</p><p>要求：多个线程必须同用一把锁</p><h3 id=2>2）</h3><p>this表示同步监视器</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Window1</span> <span style=color:#a2f;font-weight:700>implements</span> Runnable<span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> ticket <span style=color:#666>=</span> 10000<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    Object object <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Object<span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:#a2f;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>object<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>ticket <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    ticket<span style=color:#666>--;</span>
</span></span><span style=display:flex><span>                    System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;卖票，剩余 ： &#34;</span> <span style=color:#666>+</span> ticket<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=二lock类>二、Lock类</h1><p><strong>1、Synchronized</strong></p><p>2.1.1 Synchronized 关键字回顾</p><p>synchronized 是 Java 中的关键字，是一种同步锁。它修饰的对象有以下几种:</p><ol><li>修饰一个代码块，被修饰的代码块称为同步语句块，其作用的范围是大括号{} 括起来的代码，作用的对象是调用这个代码块的对象;</li><li>修饰一个方法，被修饰的方法称为同步方法，其作用的范围是整个方法，作用 的对象是调用这个方法的对象;</li></ol><p>虽然可以使用 synchronized 来定义方法，但 synchronized 并不属于方法定 义的一部分，因此，synchronized 关键字不能被继承。如果在父类中的某个方 法使用了 synchronized 关键字，而在子类中覆盖了这个方法，在子类中的这 个方法默认情况下并不是同步的，而必须显式地在子类的这个方法中加上 synchronized 关键字才可以。当然，还可以在子类方法中调用父类中相应的方 法，这样虽然子类中的方法不是同步的，但子类调用了父类的同步方法，因此， 子类的方法也就相当于同步了。</p><ol start=3><li><p>修改一个静态的方法，其作用的范围是整个静态方法，作用的对象是这个类的 所有对象</p></li><li><p>修改一个类，其作用的范围是synchronized后面括号括起来的部分，作用主 的对象是这个类的所有对象。</p></li><li><p>如果一个代码块被 synchronized 修饰了，当一个线程获取了对应的锁，并执 行该代码块时，其他线程便只能一直等待，等待获取锁的线程释放锁，而这里 获取锁的线程释放锁只会有两种情况:</p><p>1)获取锁的线程执行完了该代码块，然后线程释放对锁的占有;</p><p>2)线程执行发生异常，此时 JVM 会让线程自动释放锁。</p><p>那么如果这个获取锁的线程由于要等待 IO 或者其他原因(比如调用 sleep 方法)被阻塞了，但是又没有释放锁，其他线程便只能干巴巴地等待，试想一 下，这多么影响程序执行效率。</p><p>因此就需要有一种机制可以不让等待的线程一直无期限地等待下去(比如只等 待一定的时间或者能够响应中断)，通过 Lock 就可以办到。</p></li></ol><h1 id=三线程间的通信>三、线程间的通信</h1><h2 id=1synchronized方案><strong>1、Synchronized方案</strong></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Ticket</span> <span style=color:#666>{</span> <span style=color:#080;font-style:italic>//票数
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> number <span style=color:#666>=</span> 30<span style=color:#666>;</span>
</span></span><span style=display:flex><span>	<span style=color:#080;font-style:italic>//操作方法:卖票
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sale</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//判断:是否有票 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  	<span style=color:#a2f;font-weight:700>if</span><span style=color:#666>(</span>number <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>			System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()+</span><span style=color:#b44>&#34; : &#34;</span><span style=color:#666>+(</span>number<span style=color:#666>--)+</span><span style=color:#b44>&#34;   &#34;</span><span style=color:#666>+</span>number<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> Runnable<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//调用卖票
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 40<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    ticket<span style=color:#666>.</span><span style=color:#b44>sale</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>},</span> <span style=color:#b44>&#34;AA&#34;</span><span style=color:#666>).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span></code></pre></div><h2 id=2lock><strong>2、Lock</strong></h2><p>提供了比synchronized方法和语句可获得的更广泛的锁定操作</p><p>可重入锁：</p><p>Lock与Synchronize的区别：</p><p>1）创建资源类，在资源类创建属性和操作方法</p><p>2）在资源类操作方法</p><p>​ 判断</p><p>​ 干活</p><p>​ 通知</p><p>3）创建多个线程，调用资源类的操作方法</p><p>4）避免虚假唤醒</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span>  <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sale</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        lock<span style=color:#666>.</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//判断是否有票可卖
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>number <span style=color:#666>&gt;</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; : 卖出: &#34;</span> <span style=color:#666>+</span> number<span style=color:#666>--</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;剩下： &#34;</span> <span style=color:#666>+</span> number<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//解锁、释放锁
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            lock<span style=color:#666>.</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=3condition>3、Condition</h2><p>lock.ThreadDemo2</p><p>是一个多线程协调通信的工具类，可以让某些线程一起等待某个条件（condition），只有满足条件时，线程才会被唤醒。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Share</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> number <span style=color:#666>=</span> 0<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> Lock lock <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ReentrantLock<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> Condition condition <span style=color:#666>=</span> lock<span style=color:#666>.</span><span style=color:#b44>newCondition</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>incr</span> <span style=color:#666>()</span> <span style=color:#a2f;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        lock<span style=color:#666>.</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//判断
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span>number <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                condition<span style=color:#666>.</span><span style=color:#b44>await</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//干活
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            number<span style=color:#666>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//通知
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; :: &#34;</span> <span style=color:#666>+</span> number<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            condition<span style=color:#666>.</span><span style=color:#b44>signalAll</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            lock<span style=color:#666>.</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>decr</span> <span style=color:#666>()</span> <span style=color:#a2f;font-weight:700>throws</span> InterruptedException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        lock<span style=color:#666>.</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//判断
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span>number <span style=color:#666>!=</span> 1<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                condition<span style=color:#666>.</span><span style=color:#b44>await</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//干活
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            number<span style=color:#666>--;</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//通知
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; :: &#34;</span> <span style=color:#666>+</span> number<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            condition<span style=color:#666>.</span><span style=color:#b44>signalAll</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            lock<span style=color:#666>.</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 10<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    share<span style=color:#666>.</span><span style=color:#b44>incr</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>},</span><span style=color:#b44>&#34;AA&#34;</span><span style=color:#666>).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 10<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    share<span style=color:#666>.</span><span style=color:#b44>decr</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>},</span><span style=color:#b44>&#34;BB&#34;</span><span style=color:#666>).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span></code></pre></div><h2 id=4虚假唤醒>4、虚假唤醒</h2><p>aa + 1、 bb - 1、 cc + 1、 dd - 1</p><p>wait()在哪里睡的，就会在哪里醒，就会直接跳过判断的逻辑</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span><span style=color:#666>(</span>number <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>wait</span><span style=color:#666>();</span> 在这里睡<span>，</span>就会在这里醒来
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>解决方案就是换成while循环<span>，</span>以避免虚假唤醒
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#00a000>while</span><span style=color:#666>(</span>number <span style=color:#666>!=</span> 0<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>wait</span><span style=color:#666>();</span> 在这里睡<span>，</span>就会在这里醒来
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=四线程间定制化通信>四、线程间定制化通信</h1><p>Lock.ThreadDemo03</p><p>flag = 1 AA C1 打印5次，修改标志位flag = 2 ，通知BB</p><p>flag = 2 BB C2 打印10次，修改标志位flag = 3 ，通知CC</p><p>flag = 3 CC C3 打印15次，修改标志位flag = 1 ，通知AA</p><h1 id=五集合的线程安全>五、集合的线程安全</h1><p>lock.ThreadDemo4</p><h2 id=1arraylist线程安全问题>1、ArrayList线程安全问题</h2><p>1）concurrentModificationException演示</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> list <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 0<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 30<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        list<span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>(</span>UUID<span style=color:#666>.</span><span style=color:#b44>randomUUID</span><span style=color:#666>().</span><span style=color:#b44>toString</span><span style=color:#666>().</span><span style=color:#b44>substring</span><span style=color:#666>(</span>0<span style=color:#666>,</span> 8<span style=color:#666>));</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>list<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>},</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>)).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>2）解决方案Vector</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>List&lt;String&gt; list = new Vector&lt;&gt;();
</span></span></code></pre></div><p>3）解决方案Collections</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> list <span style=color:#666>=</span> Collections<span style=color:#666>.</span><span style=color:#b44>synchronizedList</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> ArrayList<span style=color:#666>&lt;&gt;());</span>
</span></span></code></pre></div><p>4）解决方案CopyOnWriteArrayList</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> list <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> CopyOnWriteArrayList<span style=color:#666>&lt;&gt;();</span>
</span></span></code></pre></div><p><strong>CopyOnWrite写时复制技术：</strong></p><p>支持并发读和独立写，复制一块相同大小的区域，读之前的东西，往复制的区域里面写</p><p>两个区域进行和并，最后读新的区域内容</p><h2 id=2hashset>2、hashSet</h2><p>1）解决方案CopyOnWriteArrayList</p><h2 id=3hashmap>3、hashMap</h2><p>1）解决方案ConcurrentHashMap</p><h2 id=4单例模式之懒汉式>4、单例模式之懒汉式</h2><p>SingleTest</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Bank</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#00a000>Bank</span><span style=color:#666>(){}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> Bank instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>synchronized</span> Bank <span style=color:#00a000>getInstance</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>instance <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Bank<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> instance<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//效率差
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Bank</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#00a000>Bank</span><span style=color:#666>(){}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> Bank instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> Bank <span style=color:#00a000>getInstance</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      	<span style=color:#a2f;font-weight:700>synchronized</span><span style=color:#666>(</span>Bank<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>)</span> <span style=color:#666>{</span> 
</span></span><span style=display:flex><span>        		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>instance <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            		instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Bank<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>        		<span style=color:#a2f;font-weight:700>return</span> instance<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//效率高,双重校验
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Bank</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#00a000>Bank</span><span style=color:#666>(){}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> Bank instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> Bank <span style=color:#00a000>getInstance</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      	<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>instance <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>synchronized</span><span style=color:#666>(</span>Bank<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>)</span> <span style=color:#666>{</span> 
</span></span><span style=display:flex><span>        				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>instance <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            				instance <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Bank<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>        		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>      	<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>return</span> instance<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=六多线程锁>六、多线程锁</h1><h2 id=1锁的八种情况>1、锁的八种情况</h2><p>锁的作用域</p><p><strong>结论</strong>:</p><p>一个对象里面如果有多个 synchronized 方法，某一个时刻内，只要一个线程去调用其中的 一个 synchronized 方法了， 其它的线程都只能等待，换句话说，某一个时刻内，只能有唯一一个线程去访问这些 synchronized 方法</p><p>锁的是当前对象 this，被锁定后，其它的线程都不能进入到当前对象的其它的 synchronized 方法
加个普通方法后发现和同步锁无关 换成两个对象后，不是同一把锁了，情况立刻变化。</p><p>synchronized 实现同步的基础:Java 中的每一个对象都可以作为锁。
<strong>具体表现为以下</strong> <strong>3</strong> <strong>种形式。
对于普通同步方法，锁是当前实例对象。
对于静态同步方法，锁是当前类的</strong> <strong>Class</strong> <strong>对象。
对于同步方法块，锁是</strong> <strong>Synchonized</strong> <strong>括号里配置的对象</strong> 当一个线程试图访问同步代码块时，它首先必须得到锁，退出或抛出异常时必须释放锁。 也就是说如果一个实例对象的非静态同步方法获取锁后，该实例对象的其他非静态同步方 法必须等待获取锁的方法释放锁后才能获取锁， 可是别的实例对象的非静态同步方法因为跟该实例对象的非静态同步方法用的是不同的锁， 所以毋须等待该实例对象已获取锁的非静态同步方法释放锁就可以获取他们自己的锁。 所有的静态同步方法用的也是同一把锁——类对象本身，这两把锁是两个不同的对象，所 以静态同步方法与非静态同步方法之间是不会有竞态条件的。 但是一旦一个静态同步方法获取锁后，其他的静态同步方法都必须等待该方法释放锁后才 能获取锁，而不管是同一个实例对象的静态同步方法之间，还是不同的实例对象的静态同 步方法之间，只要它们同一个类的实例对象!</p><h2 id=2公平锁和非公平锁>2、公平锁和非公平锁</h2><p><strong>公平锁</strong>：阳光普照，效率相对较低</p><p><strong>非公平锁</strong>：造成一个线程把活都干了，会出现线程饿死的情况</p><p>三个售票员同时卖票</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>private</span> Lock lock <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ReentrantLock<span style=color:#666>(</span><span style=color:#a2f;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//ReentrantLock源码
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	  <span style=color:#a2f;font-weight:700>public</span> <span style=color:#00a000>ReentrantLock</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        sync <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> NonfairSync<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#00a000>ReentrantLock</span><span style=color:#666>(</span><span style=color:#0b0;font-weight:700>boolean</span> fair<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        sync <span style=color:#666>=</span> fair <span style=color:#666>?</span> <span style=color:#a2f;font-weight:700>new</span> FairSync<span style=color:#666>()</span> <span style=color:#666>:</span> <span style=color:#a2f;font-weight:700>new</span> NonfairSync<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=3可重入锁>3、可重入锁</h2><p>可重入锁：又叫递归锁，就是拥有了这把锁之后可以进入所有需要这把锁的地方</p><p>synchronized和lock都是可重入锁</p><p>synchronized是隐式、lock显式</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>o<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>		System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; :: &#34;</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;外&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>o<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>			System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; :: &#34;</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;中&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>o<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>				System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; :: &#34;</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;内&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span></code></pre></div><p>递归锁</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>add</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    add<span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>new</span> SyncLockDemo<span style=color:#666>().</span><span style=color:#b44>add</span><span style=color:#666>();</span>
</span></span></code></pre></div><h2 id=4死锁>4、死锁</h2><p>lock.DeadLock</p><p>两个或两个以上的进程在执行过程中，因为争夺资源而造成一种互相等待的现象，如果没有外力干涉，他们无法再执行下去。</p><p>1）产生死锁的原因：</p><p>​ 系统资源不足</p><p>​ 进程运行推进顺序不合适</p><p>​ 资源分配不当</p><p>2）死锁的实现</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>a<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>		System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;持有锁a， 视图获取锁b&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>b<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>			System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;获取锁b&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>},</span> <span style=color:#b44>&#34;A&#34;</span><span style=color:#666>).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>b<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>		System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;持有锁b， 视图获取锁a&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>a<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>			System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;获取锁a&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>},</span> <span style=color:#b44>&#34;B&#34;</span><span style=color:#666>).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span></code></pre></div><p>3）验证是否是死锁</p><p>​ ①jps，类似linux、ps -ef</p><p>​ ②jstack jvm自带堆栈的跟踪工具</p><p>Jps -l</p><p>Jstack 89810</p><h1 id=七创建线程的多种方式>七、创建线程的多种方式</h1><h2 id=1继承thread类>1、继承Thread类</h2><h2 id=2实现runnable接口>2、实现Runnable接口</h2><h2 id=3callable接口>3、Callable接口</h2><p>​ @FunctionalInterface函数式接口，可以使用lam表达式做简化</p><p>​ callable可以得到线程的返回结果</p><p><strong>Callable和Runnable的区别</strong>：</p><p>1）是否有返回值</p><p>2）是否抛出异常</p><p>3）实现方法名称不同 run call</p><p>new Thread不能直接替换runnable，因为Thread类的构造方法根本没有Callable</p><p>找一个callable和runnable都有关系的类，FutureTask类</p><h2 id=4futuretask>4、FutureTask</h2><p>FutureTask构造可以传递Callable</p><p>当 call()方法完成时，结果必须存储在主线程已知的对象中，以便主线程可 以知道该线程返回的结果。为此，可以使用 Future 对象。</p><p>Java 库具有具体的 FutureTask 类型，该类型实现 Runnable 和 Future，并方 便地将两种功能组合在一起。 可以通过为其构造函数提供 Callable 来创建 FutureTask。然后，将 FutureTask 对象提供给 Thread 的构造函数以创建 Thread 对象。因此，间接地使用 Callable 创建线程。</p><p><strong>核心原理</strong>：</p><p>在主线程中需要执行比较耗时的操作时，但又不想阻塞主线程时，可以把这些 作业交给 Future 对象在后台完成</p><ol><li>当主线程将来需要时，就可以通过 Future 对象获得后台作业的计算结果或者执 行状态</li><li>一般 FutureTask 多用于耗时的计算，主线程可以在完成自己的任务后，再去 获取结果。</li><li>仅在计算完成时才能检索结果;如果计算尚未完成，则阻塞 get 方法</li><li>一旦计算完成，就不能再重新开始或取消计算</li><li>get 方法而获取结果只有在计算完成时获取，否则会一直阻塞直到任务转入完成状态，然后会返回结果或者抛出异常</li><li>get 只计算一次,因此 get 方法放到最后</li></ol><h2 id=5线程池方式>5、线程池方式</h2><h1 id=八juc强大的辅助类>八、JUC强大的辅助类</h1><h2 id=1减少计数countdownlatch>1、减少计数CountDownLatch</h2><ol><li>CountDownLatch 类可以设置一个计数器，然后通过 countDown 方法来进行 减 1 的操作，使用 await 方法等待计数器不大于 0，然后继续执行 await 方法 之后的语句。</li><li>CountDownLatch 主要有两个方法，当一个或多个线程调用 await 方法时，这 些线程会阻塞</li><li>其它线程调用 countDown 方法会将计数器减 1(调用 countDown 方法的线程 不会阻塞)</li><li>当计数器的值变为 0 时，因 await 方法阻塞的线程会被唤醒，继续执行</li></ol><p>6个同学陆续离开教室后值班同学才可以关门</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#080;font-style:italic>//创建CountDownLatch对象，设置初始值
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>CountDownLatch countDownLatch <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> CountDownLatch<span style=color:#666>(</span>6<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//6个同学陆续离开教室之后
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 6<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;同学离开教室&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        countDownLatch<span style=color:#666>.</span><span style=color:#b44>countDown</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>},</span>String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>)).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>countDownLatch<span style=color:#666>.</span><span style=color:#b44>await</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34; 班长锁门走人了&#34;</span><span style=color:#666>);</span>
</span></span></code></pre></div><h2 id=2循环栅栏cyclicbarrier>2、循环栅栏CyclicBarrier</h2><p>CyclicBarrier 看英文单词可以看出大概就是循环阻塞的意思，在使用中 CyclicBarrier 的构造方法第一个参数是目标障碍数，每次执行 CyclicBarrier 一 次障碍数会加一，如果达到了目标障碍数，才会执行 cyclicBarrier.await()之后 的语句。可以将 CyclicBarrier 理解为加 1 操作</p><p>例子：集齐7颗龙珠就可以召唤神龙</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>CyclicBarrier cyclicBarrier <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> CyclicBarrier<span style=color:#666>(</span>NUMBER<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;集齐7颗龙珠可以召唤神龙&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;</span> 7<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;星龙珠被收集了&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            cyclicBarrier<span style=color:#666>.</span><span style=color:#b44>await</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>BrokenBarrierException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=3信号灯semaphore>3、信号灯Semaphore</h2><p>Semaphore 的构造方法中传入的第一个参数是最大信号量(可以看成最大线 程池)，每个信号量初始化为一个最多只能分发一个许可证。使用 acquire 方 法获得许可证，release 方法释放许可</p><p>场景: 抢车位, 6 部汽车 3 个停车位</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#080;font-style:italic>//创建具有给定的许可数和非公平的公平设置的Semaphore
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>Semaphore<span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> permits<span style=color:#666>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//创建具有给定的许可数和给定的公平设置的Semaphore
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>Semaphore<span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> permits<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>boolean</span> fair<span style=color:#666>)</span>
</span></span></code></pre></div><p>方法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>acquair()
</span></span></code></pre></div><p>例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>				Semaphore semaphore <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Semaphore<span style=color:#666>(</span>3<span style=color:#666>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 6<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    semaphore<span style=color:#666>.</span><span style=color:#b44>acquire</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;抢到了车位&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    TimeUnit<span style=color:#666>.</span><span style=color:#b44>SECONDS</span><span style=color:#666>.</span><span style=color:#b44>sleep</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> SecureRandom<span style=color:#666>().</span><span style=color:#b44>nextInt</span><span style=color:#666>(</span>5<span style=color:#666>));</span>
</span></span><span style=display:flex><span>                    System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;离开车位&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                    semaphore<span style=color:#666>.</span><span style=color:#b44>release</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span></code></pre></div><h1 id=九读写锁>九、读写锁</h1><h2 id=1乐观锁悲观锁>1、乐观锁、悲观锁</h2><p>悲观锁：不支持并发</p><p>乐观锁：支持并发</p><h2 id=2表锁行锁>2、表锁、行锁</h2><p>表锁：对整张表上锁，表锁会产生死锁</p><p>行锁：对行上锁</p><h2 id=3读锁写锁>3、读锁、写锁</h2><p>读锁：共享锁，发生死锁</p><p>写锁：独占锁，发生死锁</p><p>线程1修改的时候，需要等待线程2读之后</p><p>线程2修改的时候，需要等待线程1读之后</p><h2 id=4读写锁readwritelock>4、读写锁ReadWriteLock</h2><p>1）读写锁介绍</p><p>一个资源可以被多个读线程访问，或者被一个写线程访问，不能同事存在读写线程，读写互斥，读读共享</p><ol><li>线程进入读锁的前提条件:</li></ol><ul><li>没有其他线程的写锁</li><li>没有写请求, 或者==有写请求，但调用线程和持有锁的线程是同一个(可重入锁)。==</li></ul><ol start=2><li>线程进入写锁的前提条件:</li></ol><ul><li><p>没有其他线程的读锁</p></li><li><p>没有其他线程的写锁</p></li><li><p>而读写锁有以下三个重要的特性:</p><p>(1)公平选择性:支持非公平(默认)和公平的锁获取方式，吞吐量还是非公 平优于公平。</p><p>(2)重进入:读锁和写锁都支持线程重进入。</p><p>(3)锁降级:遵循获取写锁、获取读锁再释放写锁的次序，写锁能够降级成为 读锁。</p></li></ul><p>2）读写锁演进</p><p>① 无锁：</p><p>​ 多线程抢夺</p><p>②添加锁：</p><p>​ 使用synchronized和ReentrantLock都是独占，每次只能一个操作，读读，读写，写写</p><p>③读写锁：</p><p>​ ReentrantReadWriteLock</p><p>​ 读读共享，提升性能，写写独占</p><p>​ 缺点一：造成锁饥饿，一直读，没有写操作，比如做地铁</p><p>​ 缺点二：读时候，不能写，只有读完之后，才可以写。写可以读，降级为读锁</p><p>3）读写锁使用案例</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>MyCache</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>volatile</span> Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> map <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> ReadWriteLock rwLock <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ReentrantReadWriteLock<span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>put</span><span style=color:#666>(</span>String key<span style=color:#666>,</span> Object value<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        rwLock<span style=color:#666>.</span><span style=color:#b44>writeLock</span><span style=color:#666>().</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//暂停一会
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;正在写操作&#34;</span> <span style=color:#666>+</span> key<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            TimeUnit<span style=color:#666>.</span><span style=color:#b44>MILLISECONDS</span><span style=color:#666>.</span><span style=color:#b44>sleep</span><span style=color:#666>(</span>300<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            map<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>key<span style=color:#666>,</span> value<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;写完了&#34;</span> <span style=color:#666>+</span> key<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            rwLock<span style=color:#666>.</span><span style=color:#b44>writeLock</span><span style=color:#666>().</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//取数据
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> Object <span style=color:#00a000>get</span><span style=color:#666>(</span>String key<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        Object result <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        rwLock<span style=color:#666>.</span><span style=color:#b44>readLock</span><span style=color:#666>().</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;正在读取操作&#34;</span> <span style=color:#666>+</span> key<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            TimeUnit<span style=color:#666>.</span><span style=color:#b44>MILLISECONDS</span><span style=color:#666>.</span><span style=color:#b44>sleep</span><span style=color:#666>(</span>300<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            result <span style=color:#666>=</span> map<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>key<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>Thread<span style=color:#666>.</span><span style=color:#b44>currentThread</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>()</span> <span style=color:#666>+</span> <span style=color:#b44>&#34;取到了&#34;</span> <span style=color:#666>+</span> key<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#666>.</span><span style=color:#b44>printStackTrace</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            rwLock<span style=color:#666>.</span><span style=color:#b44>readLock</span><span style=color:#666>().</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> result<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>ReadWriteLockDemo</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>main</span><span style=color:#666>(</span>String<span style=color:#666>[]</span> args<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        MyCache myCache <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> MyCache<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//创建线程放数据
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 5<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>final</span> <span style=color:#0b0;font-weight:700>int</span> num <span style=color:#666>=</span> i<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                myCache<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>num <span style=color:#666>+</span> <span style=color:#b44>&#34;&#34;</span><span style=color:#666>,</span> num <span style=color:#666>+</span> <span style=color:#b44>&#34;&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>},</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>)).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> 1<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> 5<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>final</span> <span style=color:#0b0;font-weight:700>int</span> num <span style=color:#666>=</span> i<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>new</span> Thread<span style=color:#666>(()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                myCache<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>num <span style=color:#666>+</span> <span style=color:#b44>&#34;&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>},</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>)).</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//写是独占锁，读是共享锁
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>2正在写操作2
</span></span><span style=display:flex><span>2写完了2
</span></span><span style=display:flex><span>3正在写操作3
</span></span><span style=display:flex><span>3写完了3
</span></span><span style=display:flex><span>4正在写操作4
</span></span><span style=display:flex><span>4写完了4
</span></span><span style=display:flex><span>5正在写操作5
</span></span><span style=display:flex><span>5写完了5
</span></span><span style=display:flex><span>1正在写操作1
</span></span><span style=display:flex><span>1写完了1
</span></span><span style=display:flex><span>1正在读取操作1
</span></span><span style=display:flex><span>3正在读取操作3
</span></span><span style=display:flex><span>4正在读取操作4
</span></span><span style=display:flex><span>2正在读取操作2
</span></span><span style=display:flex><span>5正在读取操作5
</span></span><span style=display:flex><span>5取到了5
</span></span><span style=display:flex><span>4取到了4
</span></span><span style=display:flex><span>2取到了2
</span></span><span style=display:flex><span>3取到了3
</span></span><span style=display:flex><span>1取到了1
</span></span></code></pre></div><p>4）锁降级：</p><p>将写入锁降级为读锁</p><p>获取写锁、获取读锁、释放写锁、释放读锁</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        ReentrantReadWriteLock rwLock <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ReentrantReadWriteLock<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        ReentrantReadWriteLock<span style=color:#666>.</span><span style=color:#b44>ReadLock</span> readLock <span style=color:#666>=</span> rwLock<span style=color:#666>.</span><span style=color:#b44>readLock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        ReentrantReadWriteLock<span style=color:#666>.</span><span style=color:#b44>WriteLock</span> writeLock <span style=color:#666>=</span> rwLock<span style=color:#666>.</span><span style=color:#b44>writeLock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        writeLock<span style=color:#666>.</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;上写锁&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        readLock<span style=color:#666>.</span><span style=color:#b44>lock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;上读锁&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        writeLock<span style=color:#666>.</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;释放写锁&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        readLock<span style=color:#666>.</span><span style=color:#b44>unlock</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;释放读锁&#34;</span><span style=color:#666>);</span>
</span></span></code></pre></div><h1 id=十阻塞队列blockingqueue>十、阻塞队列BlockingQueue</h1><p>队列：先进先出</p><p>栈：后进先出</p><p>![image-20220730154428259](/Users/mac/Library/Application Support/typora-user-images/image-20220730154428259.png)</p><p>当队列是空的，从队列中获取元素的操作将会被阻塞</p><p>当队列是满的，从队列中添加元素的操作将会被阻塞</p><p>试图从空的队列中获取元素的线程将会被阻塞，直到其他线程往空的队列插入新的元素</p><p>试图向已满的队列中添加新元素的线程将会被阻塞，直到其他线程从队列中移除一个或多 个元素或者完全清空，使队列变得空闲起来并后续新增</p><p>为什么需要 BlockingQueue</p><p>好处是我们不需要关心什么时候需要阻塞线程，什么时候需要唤醒线程，因为这一切 BlockingQueue 都给你一手包办了</p><p>在 concurrent 包发布以前，在多线程环境下，我们每个程序员都必须去自己控制这些细 节，尤其还要兼顾效率和线程安全，而这会给我们的程序带来不小的复杂度。</p><h2 id=1阻塞队列的基本架构>1）阻塞队列的基本架构</h2><h2 id=2阻塞队列的分类>2）阻塞队列的分类</h2><p><strong>ArrayBlockingQueue</strong></p><p>基于数组的阻塞队列实现，在 ArrayBlockingQueue 内部，维护了一个定长数 组，以便缓存队列中的数据对象，这是一个常用的阻塞队列，除了一个定长数 组外，ArrayBlockingQueue 内部还保存着两个整形变量，分别标识着队列的 头部和尾部在数组中的位置。</p><p>ArrayBlockingQueue 在生产者放入数据和消费者获取数据，都是共用同一个 锁对象，由此也意味着两者无法真正并行运行，这点尤其不同于 LinkedBlockingQueue;按照实现原理来分析，ArrayBlockingQueue 完全可 以采用分离锁，从而实现生产者和消费者操作的完全并行运行。Doug Lea 之 所以没这样去做，也许是因为 ArrayBlockingQueue 的数据写入和获取操作已 经足够轻巧，以至于引入独立的锁机制，除了给代码带来额外的复杂性外，其 在性能上完全占不到任何便宜。 ArrayBlockingQueue 和 LinkedBlockingQueue 间还有一个明显的不同之处在于，前者在插入或删除 元素时不会产生或销毁任何额外的对象实例，而后者则会生成一个额外的 Node 对象。这在长时间内需要高效并发地处理大批量数据的系统中，其对于 GC 的影响还是存在一定的区别。而在创建 ArrayBlockingQueue 时，我们还 可以控制对象的内部锁是否采用公平锁，默认采用非公平锁。</p><p>一句话总结：由数组结构组成的有界阻塞队列。</p><p><strong>LinkedBlockingQueue</strong></p><p>基于链表的阻塞队列，同 ArrayListBlockingQueue 类似，其内部也维持着一 个数据缓冲队列(该队列由一个链表构成)，当生产者往队列中放入一个数据 时，队列会从生产者手中获取数据，并缓存在队列内部，而生产者立即返回; 只有当队列缓冲区达到最大值缓存容量时(LinkedBlockingQueue 可以通过 构造函数指定该值)，才会阻塞生产者队列，直到消费者从队列中消费掉一份数据，生产者线程会被唤醒，反之对于消费者这端的处理也基于同样的原理。 而 LinkedBlockingQueue 之所以能够高效的处理并发数据，还因为其对于生 产者端和消费者端分别采用了独立的锁来控制数据同步，这也意味着在高并发 的情况下生产者和消费者可以并行地操作队列中的数据，以此来提高整个队列 的并发性能。</p><p><strong>ArrayBlockingQueue</strong> <strong>和</strong> <strong>LinkedBlockingQueue</strong> <strong>是两个最普通也是最常用 的阻塞队列，一般情况下，在处理多线程间的生产者消费者问题，使用这两个 类足以。</strong></p><p><strong>9.4.3 DelayQueue</strong></p><p>DelayQueue 中的元素只有当其指定的延迟时间到了，才能够从队列中获取到 该元素。DelayQueue 是一个没有大小限制的队列，因此往队列中插入数据的 操作(生产者)永远不会被阻塞，而只有获取数据的操作(消费者)才会被阻 塞。</p><p>==<strong>一句话总结</strong>**:** <strong>使用优先级队列实现的延迟无界阻塞队列。</strong>==</p><p><strong>9.4.4 PriorityBlockingQueue</strong></p><p>基于优先级的阻塞队列(优先级的判断通过构造函数传入的 Compator 对象来 决定)，但需要注意的是 PriorityBlockingQueue 并<strong>不会阻塞数据生产者，而 只会在没有可消费的数据时，阻塞数据的消费者</strong>。</p><p>因此使用的时候要特别注意，<strong>生产者生产数据的速度绝对不能快于消费者消费 数据的速度</strong>，否则时间一长，会最终耗尽所有的可用堆内存空间。</p><p>在实现 PriorityBlockingQueue 时，内部控制线程同步的锁采用的是<strong>公平锁</strong>。 ==<strong>一句话总结</strong>**:** <strong>支持优先级排序的无界阻塞队列。</strong>==</p><p><strong>9.4.5 SynchronousQueue</strong></p><p>一种无缓冲的等待队列，类似于无中介的直接交易，有点像原始社会中的生产 者和消费者，生产者拿着产品去集市销售给产品的最终消费者，而消费者必须 亲自去集市找到所要商品的直接生产者，如果一方没有找到合适的目标，那么 对不起，大家都在集市等待。相对于有缓冲的 BlockingQueue 来说，少了一 个中间经销商的环节(缓冲区)，如果有经销商，生产者直接把产品批发给经 销商，而无需在意经销商最终会将这些产品卖给那些消费者，由于经销商可以 库存一部分商品，因此相对于直接交易模式，总体来说采用中间经销商的模式 会吞吐量高一些(可以批量买卖);但另一方面，又因为经销商的引入，使得 产品从生产者到消费者中间增加了额外的交易环节，单个产品的及时响应性能 可能会降低。</p><p>声明一个 SynchronousQueue 有两种不同的方式，它们之间有着不太一样的行为。</p><p>公平模式和非公平模式的区别：</p><ul><li>公平模式:SynchronousQueue 会采用公平锁，并配合一个 FIFO 队列来阻塞 多余的生产者和消费者，从而体系整体的公平策略;</li><li>非公平模式(SynchronousQueue 默认):SynchronousQueue 采用非公平 锁，同时配合一个 LIFO 队列来管理多余的生产者和消费者，而后一种模式， 如果生产者和消费者的处理速度有差距，则很容易出现饥渴的情况，即可能有 某些生产者或者是消费者的数据永远都得不到处理。</li></ul><p>==<strong>一句话总结</strong>**:** <strong>不存储元素的阻塞队列，也即单个元素的队列。</strong>==</p><p><strong>9.4.6 LinkedTransferQueue</strong></p><p>LinkedTransferQueue 是一个由链表结构组成的无界阻塞 TransferQueue 队 列。相对于其他阻塞队列，LinkedTransferQueue 多了 tryTransfer 和 transfer 方法。</p><p>LinkedTransferQueue 采用一种预占模式。意思就是消费者线程取元素时，如 果队列不为空，则直接取走数据，若队列为空，那就生成一个节点(节点元素 为 null)入队，然后消费者线程被等待在这个节点上，后面生产者线程入队时 发现有一个元素为 null 的节点，生产者线程就不入队了，直接就将元素填充到该节点，并唤醒该节点等待的线程，被唤醒的消费者线程取走元素，从调用的方法返回。</p><p>==<strong>一句话总结</strong>**:** <strong>由链表组成的无界阻塞队列。</strong>==</p><p><strong>9.4.7 LinkedBlockingDeque</strong></p><p>LinkedBlockingDeque 是一个由链表结构组成的双向阻塞队列，即可以从队 列的两端插入和移除元素。对于一些指定的操作，在插入或者获取队列元素时如果队列状态不允许该操作可能会阻塞住该线程直到队列状态变更为允许操作，这里的阻塞一般有两种情况。</p><ul><li><p>插入元素时: 如果当前队列已满将会进入阻塞状态，一直等到队列有空的位置时 再讲该元素插入，该操作可以通过设置超时参数，超时后返回 false 表示操作 失败，也可以不设置超时参数一直阻塞，中断后抛出 InterruptedException 异 常</p></li><li><p>读取元素时: 如果当前队列为空会阻塞住直到队列不为空然后返回元素，同样可 以通过设置超时参数</p><p>==<strong>一句话总结</strong>**:** <strong>由链表组成的双向阻塞队列</strong>==</p></li></ul><h2 id=3阻塞队列的核心方法>3）阻塞队列的核心方法</h2><p>![image-20220730160222323](/Users/mac/Library/Application Support/typora-user-images/image-20220730160222323.png)</p><p><strong>1.放入数据</strong></p><ul><li><p>offer(anObject):表示如果可能的话,将 anObject 加到 BlockingQueue 里,即 如果 BlockingQueue 可以容纳,则返回 true,否则返回 false.<strong>(本方法不阻塞当 前执行方法的线程)</strong></p></li><li><p>offer(E o, long timeout, TimeUnit unit):可以设定等待的时间，如果在指定 的时间内，还不能往队列中加入 BlockingQueue，则返回失败</p></li><li><p>put(anObject):把 anObject 加到 BlockingQueue 里,如果 BlockQueue 没有 空间,则调用此方法的线程被阻断直到 BlockingQueue 里面有空间再继续.</p><p><strong>2.获取数据</strong></p></li><li><p>poll(time): 取走 BlockingQueue 里排在首位的对象,若不能立即取出,<strong>则可以等</strong> <strong>time</strong> <strong>参数规定的时间</strong>,取不到时返回 <strong>null</strong></p></li><li><p>poll(long timeout, TimeUnit unit):从 BlockingQueue 取出一个队首的对象， 如果在指定时间内，队列一旦有数据可取，则立即返回队列中的数据。否则知 道时间超时还没有数据可取，返回失败。</p></li><li><p>take(): 取走 BlockingQueue 里排在首位的对象,若 BlockingQueue 为空,<strong>阻断 进入等待状态直到</strong> <strong>BlockingQueue</strong> <strong>有新的数据被加入</strong>;</p></li><li><p>drainTo(): 一次性从 BlockingQueue 获取所有可用的数据对象(还可以指定 获取数据的个数)，通过该方法，可以提升获取数据效率;不需要多次分批加 锁或释放锁。</p></li></ul><h2 id=4小结>4）小结</h2><p><strong>1.</strong> <strong>在多线程领域:所谓阻塞，在某些情况下会挂起线程(即阻塞)，一旦条件 满足，被挂起的线程又会自动被唤起</strong></p><p><strong>2.</strong> <strong>为什么需要</strong> <strong>BlockingQueue?</strong></p><p>在 concurrent 包发布以前，在多线程环境下， 我们每个程序员都必须去自己控制这些细节，尤其还要兼顾效率和线程安全， 而这会给我们的程序带来不小的复杂度。</p><p>使用后我们不需要关心什么时候需要 阻塞线程，什么时候需要唤醒线程，因为这一切 BlockingQueue 都给你一手 包办了</p><h1 id=十一forkjoin>十一、Fork/Join</h1><p>**Fork：**把一个负责任务进行分拆，大事化小</p><p>**Join：**把分拆任务的结果进行合并</p><p>Executor &lt;- ExecutorService &lt;- AbstractExecutorService &lt;- ForkJoinPool</p><p>Future &lt;- ForkJoinTask &lt;- RecursiveTask</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>MyTask</span> <span style=color:#a2f;font-weight:700>extends</span> RecursiveTask<span style=color:#666>&lt;</span>Integer<span style=color:#666>&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//拆分差值不能超过10
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> Integer VALUE <span style=color:#666>=</span> 10<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> begin<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> end<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>int</span> result<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#00a000>MyTask</span><span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> begin<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>int</span> end<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>begin</span> <span style=color:#666>=</span> begin<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>end</span> <span style=color:#666>=</span> end<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>protected</span> Integer <span style=color:#00a000>compute</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//判断相加两个数值是否大于10
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>((</span>end <span style=color:#666>-</span> begin<span style=color:#666>)</span> <span style=color:#666>&lt;=</span> VALUE<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span><span style=color:#0b0;font-weight:700>int</span> i <span style=color:#666>=</span> begin<span style=color:#666>;</span> i <span style=color:#666>&lt;=</span> end<span style=color:#666>;</span> i<span style=color:#666>++)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>                result <span style=color:#666>=</span> result <span style=color:#666>+</span> i<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            <span style=color:#0b0;font-weight:700>int</span> middle <span style=color:#666>=</span> <span style=color:#666>(</span>begin <span style=color:#666>+</span> end<span style=color:#666>)</span> <span style=color:#666>/</span> 2<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//拆分左边
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            MyTask task1 <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> MyTask<span style=color:#666>(</span>begin<span style=color:#666>,</span> middle<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//拆分右边
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            MyTask task2 <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> MyTask<span style=color:#666>(</span>middle <span style=color:#666>+</span> 1<span style=color:#666>,</span> end<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//调用方法拆分
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            task1<span style=color:#666>.</span><span style=color:#b44>fork</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>            task2<span style=color:#666>.</span><span style=color:#b44>fork</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//合并结果
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            result <span style=color:#666>=</span> task1<span style=color:#666>.</span><span style=color:#b44>join</span><span style=color:#666>()</span> <span style=color:#666>+</span> task2<span style=color:#666>.</span><span style=color:#b44>join</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> result<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>ForkJoinDemo</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>main</span><span style=color:#666>(</span>String<span style=color:#666>[]</span> args<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> ExecutionException<span style=color:#666>,</span> InterruptedException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//创建MyTask
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        MyTask myTask <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> MyTask<span style=color:#666>(</span>0<span style=color:#666>,</span> 100<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//创建分支合并池对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        ForkJoinPool forkJoinPool <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ForkJoinPool<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        ForkJoinTask<span style=color:#666>&lt;</span>Integer<span style=color:#666>&gt;</span> forkJoinTask <span style=color:#666>=</span> forkJoinPool<span style=color:#666>.</span><span style=color:#b44>submit</span><span style=color:#666>(</span>myTask<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//获取最终合并之后结果
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        Integer result <span style=color:#666>=</span> forkJoinTask<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>result<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//关闭池对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        forkJoinPool<span style=color:#666>.</span><span style=color:#b44>shutdown</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/java rel=tag title=Java>#Java#</a>
<a href=/tags/%e5%b9%b6%e5%8f%91 rel=tag title=并发>#并发#</a>
<a href=/tags/%e9%94%81 rel=tag title=锁>#锁#</a>
<a href=/tags/%e5%a4%9a%e7%ba%bf%e7%a8%8b rel=tag title=多线程>#多线程#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>Java进阶-多线程并发</p><p><span>链接：</span>https://zhang4014439175.github.io/post/%E5%B9%B6%E5%8F%91/</p><p><span>作者：</span>换个方向前进</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://zhang4014439175.github.io/post/%E7%BA%BF%E7%A8%8B%E6%B1%A0/ rel=next title=Java进阶-多线程并发-线程池><i class="fa fa-chevron-left"></i> Java进阶-多线程并发-线程池</a></div><div class="post-nav-prev post-nav-item"><a href=https://zhang4014439175.github.io/post/springmvc%E4%B8%80/ rel=prev title=Java框架-Spring设计思想>Java框架-Spring设计思想
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=换个方向前进><p class=site-author-name itemprop=name>换个方向前进</p><p class="site-description motion-element" itemprop=description>在我的电脑上是正常的!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>28</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>33</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href="https://blog.csdn.net/u010837355?type=blog" target=_blank title=CSDN><i class="fa fa-fw fa-globe"></i>
CSDN</a></span>
<span class=links-of-author-item><a href=https://stackoverflow.com/users/17131342/git-zhangzm target=_blank title=StackOverFlow><i class="fa fa-fw fa-globe"></i>
StackOverFlow</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title=Nutz target=_blank>Nutz</a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>15</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/spring>Spring
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%A1%86%E6%9E%B6>框架
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/sql>SQL
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF>容器化技术
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/jvm>Jvm
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mybatis>Mybatis
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/rabbitmq>Rabbitmq
<sup>2</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>换个方向前进</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.96.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://www.aliyun.com/ style=font-weight:700 target=_blank>阿里云</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>京ICP备2022030480号-1</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/search.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var t=$(".header-inner").height()+10,n,s,e,o;$("#sidebar").css({'margin-top':t}).show(),n=parseInt($("#sidebar").css("margin-top")),s=parseInt($(".sidebar-inner").css("height")),e=n+s,o=$(".content-wrap").height(),o<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var e=document.createElement("script"),t,n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>