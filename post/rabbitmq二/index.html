<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>RabbitMQ（二） - 热爱生活与梦想</title><meta name=keywords content="博客,程序员,架构师,思考,读书,笔记,技术,分享,大数据,产品"><meta name=author content="凡梦星尘"><meta property="og:title" content="RabbitMQ（二）"><meta property="og:site_name" content="热爱生活与梦想"><meta property="og:image" content="https://zhang4014439175.github.ioimg/author.jpg"><meta name=title content="RabbitMQ（二） - 热爱生活与梦想"><meta name=description content="Sample article showcasing basic String syntax."><link rel="shortcut icon" href=https://zhang4014439175.github.ioimg/favicon.ico><link rel=apple-touch-icon href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://zhang4014439175.github.iocss/main.css rel=stylesheet type=text/css><link href=https://zhang4014439175.github.iocss/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>热爱生活与梦想</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>没有伞的孩子要学会努力奔跑!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://zhang4014439175.github.io/post/rabbitmq%E4%BA%8C/ itemprop=url>RabbitMQ（二）</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2022-03-15">2022-03-15</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1 itemprop=url rel=index><span itemprop=name>微服务</span></a>
&nbsp;</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6 itemprop=url rel=index><span itemprop=name>中间件</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>6578 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>14分钟</span></span>
<span id=/post/rabbitmq%E4%BA%8C/ class="leancloud_visitors post-visitor" data-flag-title=RabbitMQ（二）><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h1 id=一延迟队列springboot>一、延迟队列（SpringBoot）</h1><p>配置文件</p><h2 id=1基于死信完成延迟队列>1、基于死信完成延迟队列</h2><p>死信队列参数：</p><p>x-dead-letter-exchange：死信交换机</p><p>x-dead-letter-routing-key：死信路由key</p><p>x-message-ttl：消息过期时间</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>TtlQueueConfig</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//普通交换机名称
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String X_EXCHANGE <span style=color:#666>=</span> <span style=color:#b44>&#34;X&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//死信交换机名称
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String Y_DEAD_LETTER_EXCHANGE <span style=color:#666>=</span> <span style=color:#b44>&#34;Y&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//普通队列名称
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String QUEUE_A <span style=color:#666>=</span> <span style=color:#b44>&#34;QA&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String QUEUE_B <span style=color:#666>=</span> <span style=color:#b44>&#34;QB&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//死信队列名称
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String DEAD_LETTER_QUEUE <span style=color:#666>=</span> <span style=color:#b44>&#34;QD&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;xExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> DirectExchange <span style=color:#00a000>xExchange</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>new</span> DirectExchange<span style=color:#666>(</span>X_EXCHANGE<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;yExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> DirectExchange <span style=color:#00a000>yExchange</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>new</span> DirectExchange<span style=color:#666>(</span>Y_DEAD_LETTER_EXCHANGE<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueA&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Queue <span style=color:#00a000>queueA</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> arguments <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-dead-letter-exchange&#34;</span><span style=color:#666>,</span> Y_DEAD_LETTER_EXCHANGE<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-dead-letter-routing-key&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;YD&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-message-ttl&#34;</span><span style=color:#666>,</span> 10000<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> QueueBuilder<span style=color:#666>.</span><span style=color:#b44>durable</span><span style=color:#666>(</span>QUEUE_A<span style=color:#666>).</span><span style=color:#b44>withArguments</span><span style=color:#666>(</span>arguments<span style=color:#666>).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueB&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Queue <span style=color:#00a000>queueB</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> arguments <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-dead-letter-exchange&#34;</span><span style=color:#666>,</span> Y_DEAD_LETTER_EXCHANGE<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-dead-letter-routing-key&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;YD&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        arguments<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-message-ttl&#34;</span><span style=color:#666>,</span> 40000<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> QueueBuilder<span style=color:#666>.</span><span style=color:#b44>durable</span><span style=color:#666>(</span>QUEUE_B<span style=color:#666>).</span><span style=color:#b44>withArguments</span><span style=color:#666>(</span>arguments<span style=color:#666>).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueD&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Queue <span style=color:#00a000>queueD</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> QueueBuilder<span style=color:#666>.</span><span style=color:#b44>durable</span><span style=color:#666>(</span>DEAD_LETTER_QUEUE<span style=color:#666>).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>queueABindingX</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueA&#34;</span><span style=color:#666>)</span> Queue queueA<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                  <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;xExchange&#34;</span><span style=color:#666>)</span> DirectExchange xExchange<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>queueA<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>xExchange<span style=color:#666>).</span><span style=color:#b44>with</span><span style=color:#666>(</span><span style=color:#b44>&#34;XA&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>queueBBindingX</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueB&#34;</span><span style=color:#666>)</span> Queue queueB<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                  <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;xExchange&#34;</span><span style=color:#666>)</span> DirectExchange xExchange<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>queueB<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>xExchange<span style=color:#666>).</span><span style=color:#b44>with</span><span style=color:#666>(</span><span style=color:#b44>&#34;XB&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>queueDBindingY</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;queueD&#34;</span><span style=color:#666>)</span> Queue queueD<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                  <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;yExchange&#34;</span><span style=color:#666>)</span> DirectExchange yExchange<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>queueD<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>yExchange<span style=color:#666>).</span><span style=color:#b44>with</span><span style=color:#666>(</span><span style=color:#b44>&#34;YD&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=生产者>生产者：</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#b44>&#34;/sendMsg/{message}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sendMsg</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span> String message<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;当前时间：{},发送一条信息给两个TTL队列：{}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>new</span> Date<span style=color:#666>(),</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span><span style=color:#b44>&#34;X&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;XA&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;消息来自ttl为10s的队列：&#34;</span> <span style=color:#666>+</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span><span style=color:#b44>&#34;X&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;XB&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;消息来自ttl为40s的队列：&#34;</span> <span style=color:#666>+</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=消费者>消费者：</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>DeadLetterQueueConsumer</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//接收消息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@RabbitListener</span><span style=color:#666>(</span>queues <span style=color:#666>=</span> <span style=color:#b44>&#34;QD&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>receiveD</span><span style=color:#666>(</span>Message message<span style=color:#666>,</span> Channel channel<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> Exception <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        String msg <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>(</span>message<span style=color:#666>.</span><span style=color:#b44>getBody</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;当前时间：{},收到死信队列的消息:{}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>new</span> Date<span style=color:#666>().</span><span style=color:#b44>toString</span><span style=color:#666>(),</span> msg<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>第一条消息在 10S 后变成了死信消息，然后被消费者消费掉，第二条消息在 40S 之后变成了死信消息， 然后被消费掉，这样一个延时队列就打造完成了。</p><p>不过，如果这样使用的话，岂不是<strong>每增加一个新的时间需求，就要新增一个队列</strong>，这里只有 10S 和 40S 两个时间选项，如果需要一个小时后处理，那么就需要增加 TTL 为一个小时的队列，如果是预定会议室然 后提前通知这样的场景，岂不是要增加无数个队列才能满足需求?</p><h2 id=2延迟队列优化>2、延迟队列优化</h2><p>看起来似乎没什么问题，但是在最开始的时候，就介绍过如果使用在消息属性上设置 TTL 的方式，消息可能并不会按时“死亡“，因为 <strong>RabbitMQ</strong> <strong>只会检查第一个消息是否过期</strong>，如果过期则丢到死信队列， <strong>如果第一个消息的延时时长很长，而第二个消息的延时时长很短，第二个消息并不会优先得到执行</strong>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#b44>&#34;/sendMsg/{message}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sendMsg</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span> String message<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;当前时间：{},发送一条信息给两个TTL队列：{}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>new</span> Date<span style=color:#666>(),</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span><span style=color:#b44>&#34;X&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;XA&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;消息来自ttl为10s的队列：&#34;</span> <span style=color:#666>+</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span><span style=color:#b44>&#34;X&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;XB&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;消息来自ttl为40s的队列：&#34;</span> <span style=color:#666>+</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#b44>&#34;/sendExpirationMsg/{message}/{ttlTime}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sendMsgs</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span> String message<span style=color:#666>,</span> <span style=color:#a2f>@PathVariable</span> String ttlTime<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;当前时间：{},发送一条信息给两个TTL队列：{}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>new</span> Date<span style=color:#666>(),</span> ttlTime<span style=color:#666>,</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span><span style=color:#b44>&#34;X&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;XC&#34;</span><span style=color:#666>,</span> message<span style=color:#666>,</span> msg <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            msg<span style=color:#666>.</span><span style=color:#b44>getMessageProperties</span><span style=color:#666>().</span><span style=color:#b44>setExpiration</span><span style=color:#666>(</span>ttlTime<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> msg<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>});</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=3rabbitmq使用插件实现延迟队列>3、rabbitmq使用插件实现延迟队列</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#b44>&#34;/sendDelayMsg/{message}/{delayTime}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sendMsg</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span> String message<span style=color:#666>,</span> <span style=color:#a2f>@PathVariable</span> Integer delayTime<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;当前时间：{},发送一条时长{}毫秒TTL信息给队列QC:{}&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>new</span> Date<span style=color:#666>().</span><span style=color:#b44>toString</span><span style=color:#666>(),</span> delayTime<span style=color:#666>,</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span>DelayedQueueConfig<span style=color:#666>.</span><span style=color:#b44>DELAYED_EXCHANGE_NAME</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>            DelayedQueueConfig<span style=color:#666>.</span><span style=color:#b44>DELAYED_ROUTING_KEY</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>            message<span style=color:#666>,</span> msg <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        msg<span style=color:#666>.</span><span style=color:#b44>getMessageProperties</span><span style=color:#666>().</span><span style=color:#b44>setDelay</span><span style=color:#666>(</span>delayTime<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> msg<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>});</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>延时队列还有很多其他的选择，比如Java的DelayQueue，利用Redis的zset，利用Quartz或者kafka的时间轮，这些方式各有特点，看需要使用的场景。</p><h1 id=二发布确认高级>二、发布确认高级</h1><h2 id=1集成springboot>1、集成springboot</h2><h3 id=11配置>1.1、配置</h3><p>1）配置回调类型</p><p>​ Spring.rabbitmq.publisher-confirm-type=correlated</p><ul><li>None</li></ul><p>​ 禁用发布模式，是默认</p><ul><li><p>CORRELATED</p><p>发布消息成功到交换器后会触发回调方法</p><p>如果交换机写错会报错</p><p>如果路由key写错，回调收到消息，队列收不到消息</p></li><li><p>SIMPLE</p><p>经测试有两种效果，其一效果和 CORRELATED 值一样会触发回调方法，</p><p>其二在发布消息成功后使用 rabbitTemplate 调用 waitForConfirms 或 waitForConfirmsOrDie 方法 等待 broker 节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是 waitForConfirmsOrDie 方法如果返回 false 则会关闭 channel，则接下来无法发送消息到 broker</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>ConfirmConfig</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String CONFIRM_EXCHANGE_NAME <span style=color:#666>=</span> <span style=color:#b44>&#34;confirm.exchange&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String CONFIRM_QUEUE_NAME <span style=color:#666>=</span> <span style=color:#b44>&#34;confirm.queue&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>final</span> String CONFIRM_ROUTING_KEY <span style=color:#666>=</span> <span style=color:#b44>&#34;key1&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//声明业务 Exchange
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> DirectExchange <span style=color:#00a000>confirmExchange</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>new</span> DirectExchange<span style=color:#666>(</span>CONFIRM_EXCHANGE_NAME<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// 声明确认队列
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmQueue&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Queue <span style=color:#00a000>confirmQueue</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> QueueBuilder<span style=color:#666>.</span><span style=color:#b44>durable</span><span style=color:#666>(</span>CONFIRM_QUEUE_NAME<span style=color:#666>).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// 声明确认队列绑定关系
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>queueBinding</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmQueue&#34;</span><span style=color:#666>)</span> Queue queue<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmExchange&#34;</span><span style=color:#666>)</span> DirectExchange exchange<span style=color:#666>){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>queue<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>exchange<span style=color:#666>).</span><span style=color:#b44>with</span><span style=color:#666>(</span>CONFIRM_ROUTING_KEY<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=12回调>1.2、回调</h3><p>消息被接收后，回调确认已接收消息</p><p>实现回退的话，会回退没有收到的消息</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Component</span> <span style=color:#080;font-style:italic>//第一步执行
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>MyCallBack</span> <span style=color:#a2f;font-weight:700>implements</span> RabbitTemplate<span style=color:#666>.</span><span style=color:#b44>ConfirmCallback</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Autowired</span>  <span style=color:#080;font-style:italic>//第二步执行
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>private</span> RabbitTemplate rabbitTemplate<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@PostConstruct</span> <span style=color:#080;font-style:italic>//第三步执行  注入
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>setConfirmCallback</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 交换机确认回调方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 1.发消息 交换机接收到了 回调
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.1 correlationData保存回调消息的ID及相关信息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.2 交换机收到消息 ack = true
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.3 cause null
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 2.发消息 交换机接受失败了 回调
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.1 correlationData 保存回调消息的ID及相关信息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.2 交换机接收到消息 ack = false
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.3 cause 失败的原因
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>confirm</span><span style=color:#666>(</span>CorrelationData correlationData<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>boolean</span> ack<span style=color:#666>,</span> String cause<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        String id <span style=color:#666>=</span> correlationData <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>?</span> correlationData<span style=color:#666>.</span><span style=color:#b44>getId</span><span style=color:#666>()</span> <span style=color:#666>:</span> <span style=color:#b44>&#34;&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>ack<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;交换机已经收到Id为 {} 的消息&#34;</span><span style=color:#666>,</span> id<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;交换机还没有收到Id为 {} 的消息，由于原因 {}&#34;</span><span style=color:#666>,</span> id<span style=color:#666>,</span> cause<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=13生产者>1.3、生产者</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@GetMapping</span><span style=color:#666>(</span><span style=color:#b44>&#34;/sendMessage/{message}&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>sendMessage</span><span style=color:#666>(</span><span style=color:#a2f>@PathVariable</span> String message<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        CorrelationData correlationData <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> CorrelationData<span style=color:#666>(</span><span style=color:#b44>&#34;1&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>convertAndSend</span><span style=color:#666>(</span>ConfirmConfig<span style=color:#666>.</span><span style=color:#b44>CONFIRM_EXCHANGE_NAME</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;key2&#34;</span><span style=color:#666>,</span> message<span style=color:#666>,</span> correlationData<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;发送消息内容:{}&#34;</span><span style=color:#666>,</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h3 id=14消费者>1.4、消费者</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Consumer</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@RabbitListener</span><span style=color:#666>(</span>queues <span style=color:#666>=</span> ConfirmConfig<span style=color:#666>.</span><span style=color:#b44>CONFIRM_QUEUE_NAME</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>receiveConfirmMessage</span><span style=color:#666>(</span>Message message<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>(</span>message<span style=color:#666>.</span><span style=color:#b44>getBody</span><span style=color:#666>()));</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;接收到队列confirm.queue消息：{}&#34;</span><span style=color:#666>,</span> message<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>如果修改key之后，消息无法被路由</p><h2 id=2回退消息无法被路由时处理>2、回退消息（无法被路由时处理）</h2><p>Spring.rabbitmq.publisher-returns=true</p><p><strong>在仅开启了生产者确认机制的情况下，交换机接收到消息后，会直接给消息生产者发送确认消息</strong>，<strong>如 果发现该消息不可路由，那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的</strong>。那么如何 让无法被路由的消息帮我想办法处理一下?最起码通知我一声，我好自己处理啊。通过设置 mandatory 参 数可以在当消息传递过程中不可达目的地时将消息返回给生产者。</p><h3 id=21升级回调>2.1升级回调</h3><p>​ Spring.rabbitmq.publisher-returns=true</p><p>​ 实现回退方法，重写回退方法，配置初始化方法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Component</span> <span style=color:#080;font-style:italic>//第一步执行
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>MyCallBack</span> <span style=color:#a2f;font-weight:700>implements</span> RabbitTemplate<span style=color:#666>.</span><span style=color:#b44>ConfirmCallback</span><span style=color:#666>,</span> RabbitTemplate<span style=color:#666>.</span><span style=color:#b44>ReturnCallback</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Autowired</span>  <span style=color:#080;font-style:italic>//第二步执行
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>private</span> RabbitTemplate rabbitTemplate<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@PostConstruct</span> <span style=color:#080;font-style:italic>//第三步执行  注入
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>setConfirmCallback</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rabbitTemplate<span style=color:#666>.</span><span style=color:#b44>setReturnCallback</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 交换机确认回调方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 1.发消息 交换机接收到了 回调
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.1 correlationData保存回调消息的ID及相关信息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.2 交换机收到消息 ack = true
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  1.3 cause null
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 2.发消息 交换机接受失败了 回调
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.1 correlationData 保存回调消息的ID及相关信息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.2 交换机接收到消息 ack = false
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     *  2.3 cause 失败的原因
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>confirm</span><span style=color:#666>(</span>CorrelationData correlationData<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>boolean</span> ack<span style=color:#666>,</span> String cause<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        String id <span style=color:#666>=</span> correlationData <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>?</span> correlationData<span style=color:#666>.</span><span style=color:#b44>getId</span><span style=color:#666>()</span> <span style=color:#666>:</span> <span style=color:#b44>&#34;&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>ack<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;交换机已经收到Id为 {} 的消息&#34;</span><span style=color:#666>,</span> id<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span><span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;交换机还没有收到Id为 {} 的消息，由于原因 {}&#34;</span><span style=color:#666>,</span> id<span style=color:#666>,</span> cause<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 通过设置 mandatory 参数可以在当消息传递过程中不可达目的地时将消息返回给生产者
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * 只有不可达目的地时，才进行回退
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>returnedMessage</span><span style=color:#666>(</span>Message message<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>int</span> replyCode<span style=color:#666>,</span> String replyText<span style=color:#666>,</span> String exchange<span style=color:#666>,</span> String routingKey<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;消息{},被交换机{}退回，退回原因:{},路由 key:{}&#34;</span><span style=color:#666>,</span><span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>(</span>message<span style=color:#666>.</span><span style=color:#b44>getBody</span><span style=color:#666>()),</span>exchange<span style=color:#666>,</span>replyText<span style=color:#666>,</span> routingKey<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=3备份交换机>3、备份交换机</h2><p><img src=/Users/mac/Desktop/%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA.jpeg alt=备份交换机></p><p>3.1 确认交换机要转发消息到备份交换机，需要修改交换机类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#080;font-style:italic>//普通确认交换机
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> DirectExchange <span style=color:#00a000>confirmExchange</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>new</span> DirectExchange<span style=color:#666>(</span>CONFIRM_EXCHANGE_NAME<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//转发备份交换机的确认交换机
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;confirmExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> DirectExchange <span style=color:#00a000>confirmExchange</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> ExchangeBuilder<span style=color:#666>.</span><span style=color:#b44>directExchange</span><span style=color:#666>(</span>CONFIRM_EXCHANGE_NAME<span style=color:#666>).</span><span style=color:#b44>durable</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>true</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>                <span style=color:#666>.</span><span style=color:#b44>withArgument</span><span style=color:#666>(</span><span style=color:#b44>&#34;alternate-exchange&#34;</span><span style=color:#666>,</span> BACKUP_EXCHANGE_NAME<span style=color:#666>).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//声明备份 Exchange
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span><span style=color:#666>(</span><span style=color:#b44>&#34;backupExchange&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> FanoutExchange <span style=color:#00a000>backupExchange</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>new</span> FanoutExchange<span style=color:#666>(</span>BACKUP_EXCHANGE_NAME<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//声明备份队列绑定备份交换机
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>backupBinding</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;backupQueue&#34;</span><span style=color:#666>)</span> Queue backupQueue<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;backupExchange&#34;</span><span style=color:#666>)</span> FanoutExchange backupExchange<span style=color:#666>){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>backupQueue<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>backupExchange<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// 声明报警队列绑定备份交换机
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Binding <span style=color:#00a000>warningBinding</span><span style=color:#666>(</span><span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;warningQueue&#34;</span><span style=color:#666>)</span> Queue warningQueue<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                  <span style=color:#a2f>@Qualifier</span><span style=color:#666>(</span><span style=color:#b44>&#34;backupExchange&#34;</span><span style=color:#666>)</span> FanoutExchange 				
</span></span><span style=display:flex><span>                                  backupExchange<span style=color:#666>){</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> BindingBuilder<span style=color:#666>.</span><span style=color:#b44>bind</span><span style=color:#666>(</span>warningQueue<span style=color:#666>).</span><span style=color:#b44>to</span><span style=color:#666>(</span>backupExchange<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>WarningConsumer</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//接收报警信息
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f>@RabbitListener</span><span style=color:#666>(</span>queues <span style=color:#666>=</span> ConfirmConfig<span style=color:#666>.</span><span style=color:#b44>WARNING_QUEUE_NAME</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>receiveWarningMsg</span><span style=color:#666>(</span>Message message<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        String msg <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>(</span>message<span style=color:#666>.</span><span style=color:#b44>getBody</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;报警发现不可路由消息:{}&#34;</span><span style=color:#666>,</span> msg<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>3.2 mandatory 参数与备份交换机可以一起使用的时候，如果两者同时开启，消息究竟何去何从?谁优先 级高，经过上面结果显示答案是<strong>备份交换机优先级高</strong>。</p><h2 id=4幂等性>4、幂等性</h2><h3 id=41概念>4.1 概念</h3><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。 举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常， 此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱 了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等</p><h3 id=42消息重复消费>4.2 消息重复消费</h3><p>消费者在消费 MQ 中的消息时，MQ 已把消息发送给消费者，消费者在给 MQ 返回 ack 时网络中断， 故 MQ 未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但 实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p><h3 id=43解决思路>4.3 解决思路</h3><p>MQ 消费者的幂等性的解决一般使用全局 ID 或者写个唯一标识比如时间戳 或者 UUID 或者订单消费 者消费 MQ 中的消息也可利用 MQ 的该 id 来判断，或者可按自己的规则生成一个全局唯一 id，每次消费消息时用该 id 先判断该消息是否已消费过。</p><h3 id=44消费端的幂等性保障>4.4 消费端的幂等性保障</h3><p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性， 这就意味着我们的消息永远不会被消费多次，即使我们收到了一样的消息。业界主流的幂等性有两种操作:a. 唯一 ID+指纹码机制,利用数据库主键去重, b.利用 redis 的原子性去实现</p><p>4.4.1唯一 ID+指纹码机制</p><p>指纹码:我们的一些规则或者时间戳加别的服务给到的唯一信息码,它并不一定是我们系统生成的，基 本都是由我们的业务规则拼接而来，但是一定要保证唯一性，然后就利用查询语句进行判断这个 id 是否存 在数据库中,优势就是实现简单就一个拼接，然后查询判断是否重复;劣势就是在高并发时，如果是单个数 据库就会有写入性能瓶颈当然也可以采用分库分表提升性能，但也不是我们最推荐的方式。</p><p>4.4.2Redis 原子性</p><p>利用 redis 执行 setnx 命令，天然具有幂等性。从而实现不重复消费</p><h2 id=5优先级队列>5、优先级队列</h2><p>在我们系统中有一个<strong>订单催付</strong>的场景，我们的客户在天猫下的订单,淘宝会及时将订单推送给我们，如 果在用户设定的时间内未付款那么就会给用户推送一条短信提醒，很简单的一个功能对吧，但是，tmall 商家对我们来说，肯定是要分大客户和小客户的对吧，比如像苹果，小米这样大商家一年起码能给我们创 造很大的利润，所以理应当然，他们的订单必须得到优先处理，而曾经我们的后端系统是使用 redis 来存 放的定时轮询，大家都知道 redis 只能用 List 做一个简简单单的消息队列，并不能实现一个优先级的场景，所以订单量大了后采用 RabbitMQ 进行改造和优化,如果发现是大客户的订单给一个相对比较高的优先级， 否则就是默认优先级。</p><h2 id=6惰性队列学习>6、惰性队列（学习）</h2><p>RabbitMQ 从 3.6.0 版本开始引入了惰性队列的概念。惰性队列会尽可能的将消息存入磁盘中，而在消费者消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是能够支持更长的队列，即支持 更多的消息存储。当消费者由于各种各样的原因(比如消费者下线、宕机亦或者是由于维护而关闭等)而致 使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。</p><p>默认情况下，当生产者将消息发送到 RabbitMQ 的时候，队列中的消息会尽可能的存储在内存之中， 这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留 一份备份。当 RabbitMQ 需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的 时间，也会阻塞队列的操作，进而无法接收新的消息。虽然 RabbitMQ 的开发者们一直在升级相关的算法， 但是效果始终不太理想，尤其是在消息量特别大的时候。</p><h3 id=61两种模式>6.1、两种模式</h3><p>队列具备两种模式:default 和 lazy。默认的为 default 模式，在 3.6.0 之前的版本无需做任何变更。lazy 模式即为惰性队列的模式，可以通过调用 channel.queueDeclare 方法的时候在参数中设置，也可以通过 Policy 的方式设置，如果一个队列同时使用这两种方式设置的话，那么 Policy 的方式具备更高的优先级。 如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的。</p><p>在队列声明的时候可以通过“x-queue-mode”参数来设置队列的模式，取值为“default”和“lazy”。下面示 例中演示了一个惰性队列的声明细节:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> args <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;();</span> 
</span></span><span style=display:flex><span>args<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span><span style=color:#b44>&#34;x-queue-mode&#34;</span><span style=color:#666>,</span> <span style=color:#b44>&#34;lazy&#34;</span><span style=color:#666>);</span> 
</span></span><span style=display:flex><span>channel<span style=color:#666>.</span><span style=color:#b44>queueDeclare</span><span style=color:#666>(</span><span style=color:#b44>&#34;myqueue&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span></code></pre></div><h3 id=62内存开销>6.2、内存开销</h3><p>在发送 1 百万条消息，每条消息大概占 1KB 的情况下，普通队列占用内存是 1.2GB，而惰性队列仅仅 占用 1.5MB</p><h1 id=三rabbitmq集群>三、rabbitmq集群</h1><h2 id=1集群clustering>1、集群clustering</h2><h3 id=11使用集群的原因>1.1、使用集群的原因</h3><p>最开始我们介绍了如何安装及运行 RabbitMQ 服务，不过这些是单机版的，无法满足目前真实应用的 要求。如果 RabbitMQ 服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办?单台 RabbitMQ 服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢?购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是 解决实际问题的关键.</p><h3 id=12搭建步骤>1.2、搭建步骤</h3><p>1.2.1.修改 3 台机器的主机名称</p><p>​ vim /etc/hostname</p><p>1.2.2.配置各个节点的 hosts 文件，让各个节点都能互相识别对方</p><p>​ vim /etc/hosts 10.211.55.74 node1 10.211.55.75 node2 10.211.55.76 node3</p><p>1.2.3.以确保各个节点的 cookie 文件使用的是同一个值 在 node1 上执行远程操作命令</p><p>​ scp /var/lib/rabbitmq/.erlang.cookie root@node2:/var/lib/rabbitmq/.erlang.cookie</p><p>​ scp /var/lib/rabbitmq/.erlang.cookie root@node3:/var/lib/rabbitmq/.erlang.cookie</p><p>1.2.4.启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以 下命令)</p><p>​ rabbitmq-server -detached</p><p>1.2.5.在节点 2 执行</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rabbitmqctl stop_app
</span></span><span style=display:flex><span><span style=color:#666>(</span>rabbitmqctl stop 会将 Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务<span style=color:#666>)</span>
</span></span><span style=display:flex><span>rabbitmqctl reset
</span></span><span style=display:flex><span>rabbitmqctl join_cluster rabbit@node1
</span></span><span style=display:flex><span>rabbitmqctl start_app<span style=color:#666>(</span>只启动应用服务<span style=color:#666>)</span> 
</span></span></code></pre></div><p>1.2.6.在节点 3 执行</p><pre><code>rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@node2 rabbitmqctl start_app
</code></pre><p>1.2.7.集群状态</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>rabbitmqctl cluster_status
</span></span></code></pre></div><p>1.2.8.需要重新设置用户</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic>#创建账号</span>
</span></span><span style=display:flex><span>rabbitmqctl add_user admin <span style=color:#666>123</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#设置用户角色</span>
</span></span><span style=display:flex><span>rabbitmqctl set_user_tags admin administrator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#设置用户权限</span>
</span></span><span style=display:flex><span>rabbitmqctl set_permissions -p <span style=color:#b44>&#34;/&#34;</span> admin <span style=color:#b44>&#34;.*&#34;</span> <span style=color:#b44>&#34;.*&#34;</span> <span style=color:#b44>&#34;.*&#34;</span> 
</span></span></code></pre></div><p>1.2.9.解除集群节点(node2 和 node3 机器分别执行)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rabbitmqctl stop_app 
</span></span><span style=display:flex><span>rabbitmqctl reset 
</span></span><span style=display:flex><span>rabbitmqctl start_app 
</span></span><span style=display:flex><span>rabbitmqctl cluster_status
</span></span><span style=display:flex><span>rabbitmqctl forget_cluster_node rabbit@node2<span style=color:#666>(</span>node1 机器上执行）
</span></span></code></pre></div><h2 id=2镜像队列>2、镜像队列</h2><p>如果 RabbitMQ 集群中只有一个 Broker 节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能会导致消息的丢失。可以将所有消息都设置为持久化，并且对应队列的 durable 属性也设置为 true， 但是这样仍然无法避免由于缓存导致的问题:因为消息在发送之后和被写入磁盘井执行刷盘动作之间存在 一个短暂却会产生问题的时间窗。通过 publisherconfirm 机制能够确保客户端知道哪些消息己经存入磁盘， 尽管如此，一般不希望遇到因单点故障导致的服务不可用。</p><p>引入镜像队列(Mirror Queue)的机制，可以将队列镜像到集群中的其他 Broker 节点之上，如果集群中 的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性。</p><p>2.1步骤</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>1、启动三台集群节点
</span></span><span style=display:flex><span>2、随便找一个节点添加 policy ， admin右边
</span></span><span style=display:flex><span>	name：随便
</span></span><span style=display:flex><span>	pattern：正则式 ^mirrior，mirrior为前缀的队列
</span></span><span style=display:flex><span>		ha-mode				exactly
</span></span><span style=display:flex><span>		ha-params 		2
</span></span><span style=display:flex><span>		ha-sync-mode	automatic
</span></span><span style=display:flex><span>3、在 node1 上创建一个队列发送一条消息，队列存在镜像队列
</span></span><span style=display:flex><span>4、停掉 node1 之后发现 node2 成为镜像队列
</span></span><span style=display:flex><span>5、就算整个集群只剩下一台机器了，依然能消费队列里面的消息。说明队列里面的消息被镜像队列传递到相应机器里面了
</span></span></code></pre></div><h2 id=3haproxy--keepalive实现负载均衡>3、Haproxy + Keepalive实现负载均衡</h2><p>HAProxy 提供高可用性、负载均衡及基于 TCPHTTP 应用的代理，支持虚拟主机，它是免费、快速并 且可靠的一种解决方案，包括 Twitter,Reddit,StackOverflow,GitHub 在内的多家知名互联网公司在使用。 HAProxy 实现了一种事件驱动、单一进程模型，此模型支持非常大的井发连接数。</p><p>扩展 nginx,lvs,haproxy 之间的区别: <a href=http://www.ha97.com/5646.html target=_blank rel=noopener>http://www.ha97.com/5646.html</a></p><p>3.1补助</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>1、下载 haproxy<span style=color:#666>(</span>在 node1 和 node2<span style=color:#666>)</span> 
</span></span><span style=display:flex><span>		yum -y install haproxy
</span></span><span style=display:flex><span>2、修改 node1 和 node2 的 haproxy.cfg
</span></span><span style=display:flex><span>		vim /etc/haproxy/haproxy.cfg 需要修改红色 IP 为当前机器 IP
</span></span><span style=display:flex><span>3、在两台节点启动 haproxy
</span></span><span style=display:flex><span>		haproxy -f /etc/haproxy/haproxy.cfg
</span></span><span style=display:flex><span>		ps -ef | grep haproxy 
</span></span><span style=display:flex><span>4、访问地址
</span></span><span style=display:flex><span>		http://10.211.55.71:8888/stats
</span></span></code></pre></div><p>3.2Keepalived 实现双机(主备)热备</p><p>试想如果前面配置的 HAProxy 主机突然宕机或者网卡失效，那么虽然 RbbitMQ 集群没有任何故障但是 对于外界的客户端来说所有的连接都会被断开结果将是灾难性的为了确保负载均衡服务的可靠性同样显得 十分重要，这里就要引入 Keepalived 它能够通过自身健康检查、资源接管功能做高可用(双机热备)，实现 故障转移.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>1.下载 keepalived
</span></span><span style=display:flex><span>		yum -y install keepalived
</span></span><span style=display:flex><span>2.节点 node1 配置文件
</span></span><span style=display:flex><span>		vim /etc/keepalived/keepalived.conf 
</span></span><span style=display:flex><span>		把资料里面的 keepalived.conf 修改之后替换
</span></span><span style=display:flex><span>3.节点 node2 配置文件
</span></span><span style=display:flex><span>		需要修改 global_defs 的 router_id,如:nodeB 
</span></span><span style=display:flex><span>		其次要修改 vrrp_instance_VI 中 state 为<span style=color:#b44>&#34;BACKUP&#34;</span>; 
</span></span><span style=display:flex><span>		最后要将 priority 设置为小于 <span style=color:#666>100</span> 的值
</span></span><span style=display:flex><span>4.添加 haproxy_chk.sh
</span></span><span style=display:flex><span>		<span style=color:#666>(</span>为了防止 HAProxy 服务挂掉之后 Keepalived 还在正常工作而没有切换到 Backup 上，所以这里需要编写一个脚本来检测 HAProxy 务的状态,当 HAProxy 服务挂掉之后该脚本会自动重启 HAProxy 的服务，如果不成功则关闭 			Keepalived 服务，这样便可以切换到 Backup 继续工作<span style=color:#666>)</span>
</span></span><span style=display:flex><span>		vim /etc/keepalived/haproxy_chk.sh<span style=color:#666>(</span>可以直接上传文件<span style=color:#666>)</span>
</span></span><span style=display:flex><span>		修改权限 chmod <span style=color:#666>777</span> /etc/keepalived/haproxy_chk.sh
</span></span><span style=display:flex><span>5.启动 keepalive 命令<span style=color:#666>(</span>node1 和 node2 启动<span style=color:#666>)</span> 
</span></span><span style=display:flex><span>		systemctl start keepalived
</span></span><span style=display:flex><span>6.观察 Keepalived 的日志
</span></span><span style=display:flex><span>		tail -f /var/log/messages -n <span style=color:#666>200</span>
</span></span><span style=display:flex><span>7.观察最新添加的 vip 
</span></span><span style=display:flex><span>		ip add show
</span></span><span style=display:flex><span>8.node1 模拟 keepalived 关闭状态 
</span></span><span style=display:flex><span>		systemctl stop keepalived
</span></span><span style=display:flex><span>9.使用 vip 地址来访问 rabbitmq 集群
</span></span></code></pre></div><h2 id=4federation-exchange>4、Federation Exchange</h2><p>联邦交换机</p><h2 id=5federation-queue>5、Federation Queue</h2><p>联邦队列</p><h2 id=6shovel>6、Shovel</h2><p>Federation 具备的数据转发功能类似，Shovel 够可靠、持续地从一个 Broker 中的队列(作为源端，即 source)拉取数据并转发至另一个 Broker 中的交换器(作为目的端，即 destination)。作为源端的队列和作 为目的端的交换器可以同时位于同一个 Broker，也可以位于不同的 Broker 上。Shovel 可以翻译为"铲子"， 是一种比较形象的比喻，这个"铲子"可以将消息从一方"铲子"另一方。Shovel 行为就像优秀的客户端应用 程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理</p></div><footer class=post-footer><div class=post-tags><a href=/tags/rabbitmq rel=tag title=RabbitMQ>#RabbitMQ#</a>
<a href=/tags/%e5%89%8a%e5%b3%b0 rel=tag title=削峰>#削峰#</a>
<a href=/tags/%e8%a7%a3%e8%80%a6 rel=tag title=解耦>#解耦#</a>
<a href=/tags/%e5%bc%82%e6%ad%a5 rel=tag title=异步>#异步#</a>
<a href=/tags/%e4%b8%ad%e9%97%b4%e4%bb%b6 rel=tag title=中间件>#中间件#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>RabbitMQ（二）</p><p><span>链接：</span>https://zhang4014439175.github.io/post/rabbitmq%E4%BA%8C/</p><p><span>作者：</span>凡梦星尘</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://zhang4014439175.github.io/post/elasticsearch/ rel=next title=Elasticsearch><i class="fa fa-chevron-left"></i> Elasticsearch</a></div><div class="post-nav-prev post-nav-item"><a href=https://zhang4014439175.github.io/post/rabbitmq%E4%B8%80/ rel=prev title=RabbitMQ（一）>RabbitMQ（一）
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=凡梦星尘><p class=site-author-name itemprop=name>凡梦星尘</p><p class="site-description motion-element" itemprop=description>再平凡的人也有属于他自己的梦想!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>29</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>33</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/elkan1788/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/people/fan-meng-xing-chen-1 target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title=Nutz target=_blank>Nutz</a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>15</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/spring>Spring
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%A1%86%E6%9E%B6>框架
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/sql>SQL
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF>容器化技术
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/jvm>Jvm
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mybatis>Mybatis
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/rabbitmq>Rabbitmq
<sup>2</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>热爱生活与梦想</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.96.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://www.ucloud.cn/ style=font-weight:700 target=_blank>UCloud云存储</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>粤ICP备18047355号</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/search.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var t=$(".header-inner").height()+10,n,s,e,o;$("#sidebar").css({'margin-top':t}).show(),n=parseInt($("#sidebar").css("margin-top")),s=parseInt($(".sidebar-inner").css("height")),e=n+s,o=$(".content-wrap").height(),o<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var e=document.createElement("script"),t,n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>