<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>docker（二）集群 - 换个方向前进</title><meta name=keywords content="博客,程序员,架构师,思考,读书,笔记,技术,分享,大数据,产品"><meta name=author content="keepmovinggg"><meta property="og:title" content="docker（二）集群"><meta property="og:site_name" content="换个方向前进"><meta property="og:image" content="https://zhang4014439175.github.ioimg/author.jpg"><meta name=title content="docker（二）集群 - 换个方向前进"><meta name=description content="Sample article showcasing basic String syntax."><link rel="shortcut icon" href=https://zhang4014439175.github.ioimg/favicon.ico><link rel=apple-touch-icon href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://zhang4014439175.github.ioimg/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://zhang4014439175.github.iocss/main.css rel=stylesheet type=text/css><link href=https://zhang4014439175.github.iocss/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>换个方向前进</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>愿每个目标坚定的自己，都能在未来无惧内卷、自信昂扬!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://zhang4014439175.github.io/post/docker%E4%B8%89%E5%AE%89%E8%A3%85mysql%E5%92%8Credis%E9%9B%86%E7%BE%A4/ itemprop=url>docker（二）集群</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="18182-02-18">18182-02-18</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2 itemprop=url rel=index><span itemprop=name>运维部署</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>4117 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>9分钟</span></span>
<span id=/post/docker%E4%B8%89%E5%AE%89%E8%A3%85mysql%E5%92%8Credis%E9%9B%86%E7%BE%A4/ class="leancloud_visitors post-visitor" data-flag-title=docker（二）集群><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h1 id=一mysql主从复制>一、mysql主从复制</h1><p>新建主服务器容器实例3307</p><p>进入/mydata/mysql-master/conf目录下新建my.cnf</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#666>[</span>mysqld<span style=color:#666>]</span> 
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置server_id，同一局域网中需要唯一 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>server_id</span><span style=color:#666>=</span>101  
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 指定不需要同步的数据库名称 </span>
</span></span><span style=display:flex><span>binlog-ignore-db<span style=color:#666>=</span>mysql   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 开启二进制日志功能 </span>
</span></span><span style=display:flex><span>log-bin<span style=color:#666>=</span>mall-mysql-bin   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置二进制日志使用内存大小（事务） </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>binlog_cache_size</span><span style=color:#666>=</span>1M   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置使用的二进制日志格式（mixed,statement,row） </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>binlog_format</span><span style=color:#666>=</span>mixed   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 二进制日志过期清理时间。默认值为0，表示不自动清理。 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>expire_logs_days</span><span style=color:#666>=</span>7   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。 </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>slave_skip_errors</span><span style=color:#666>=</span><span style=color:#666>1062</span> 
</span></span></code></pre></div><p>修改完配置后重启master实例</p><p>进入mysql-master容器</p><p>master容器实例内创建数据同步用户</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CREATE USER <span style=color:#b44>&#39;slave&#39;</span>@<span style=color:#b44>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#b44>&#39;123456&#39;</span>;
</span></span><span style=display:flex><span>GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span style=color:#b44>&#39;slave&#39;</span>@<span style=color:#b44>&#39;%&#39;</span>;
</span></span></code></pre></div><p>新建从服务器容器实例3308</p><p>进入/mydata/mysql-slave/conf目录下新建my.cnf</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#666>[</span>mysqld<span style=color:#666>]</span> 
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置server_id，同一局域网中需要唯一 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>server_id</span><span style=color:#666>=</span><span style=color:#666>102</span> 
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 指定不需要同步的数据库名称 </span>
</span></span><span style=display:flex><span>binlog-ignore-db<span style=color:#666>=</span>mysql   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用 </span>
</span></span><span style=display:flex><span>log-bin<span style=color:#666>=</span>mall-mysql-slave1-bin   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置二进制日志使用内存大小（事务） </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>binlog_cache_size</span><span style=color:#666>=</span>1M   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置使用的二进制日志格式（mixed,statement,row） </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>binlog_format</span><span style=color:#666>=</span>mixed   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 二进制日志过期清理时间。默认值为0，表示不自动清理。 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>expire_logs_days</span><span style=color:#666>=</span>7   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。 </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>slave_skip_errors</span><span style=color:#666>=</span>1062   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## relay_log配置中继日志 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>relay_log</span><span style=color:#666>=</span>mall-mysql-relay-bin   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## log_slave_updates表示slave将复制事件写进自己的二进制日志 </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>log_slave_updates</span><span style=color:#666>=</span>1   
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## slave设置为只读（具有super权限的用户除外） </span>
</span></span><span style=display:flex><span><span style=color:#b8860b>read_only</span><span style=color:#666>=</span><span style=color:#666>1</span> 
</span></span></code></pre></div><p>修改完配置后重启slave实例</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>docker restart mysql-slave
</span></span></code></pre></div><p>在主数据库中查看主从同步状态</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>show master status;
</span></span></code></pre></div><p>进入mysql-slave容器</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>docker exec -it mysql-slave /bin/bash
</span></span></code></pre></div><p>在从数据库中配置主从复制</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>change master to <span style=color:#b8860b>master_host</span><span style=color:#666>=</span><span style=color:#b44>&#39;宿主机ip&#39;</span>, <span style=color:#b8860b>master_user</span><span style=color:#666>=</span><span style=color:#b44>&#39;slave&#39;</span>, <span style=color:#b8860b>master_password</span><span style=color:#666>=</span><span style=color:#b44>&#39;123456&#39;</span>, <span style=color:#b8860b>master_port</span><span style=color:#666>=</span>3307, <span style=color:#b8860b>master_log_file</span><span style=color:#666>=</span><span style=color:#b44>&#39;mall-mysql-bin.000001&#39;</span>, <span style=color:#b8860b>master_log_pos</span><span style=color:#666>=</span>617, <span style=color:#b8860b>master_connect_retry</span><span style=color:#666>=</span>30; 
</span></span></code></pre></div><p>在从数据库中查看主从同步状态</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>show slave status <span style=color:#b62;font-weight:700>\G</span>;
</span></span></code></pre></div><p>在从数据库中开启主从同步</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mysql中 start slave
</span></span></code></pre></div><p>查看从数据库状态发现已经同步</p><p>主从复制测试</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -p 3307:3306 --name mysql-master <span style=color:#b62;font-weight:700>\ </span>
</span></span><span style=display:flex><span>-v /mydata/mysql-master/log:/var/log/mysql <span style=color:#b62;font-weight:700>\ </span>
</span></span><span style=display:flex><span>-v /mydata/mysql-master/data:/var/lib/mysql <span style=color:#b62;font-weight:700>\ </span>
</span></span><span style=display:flex><span>-v /mydata/mysql-master/conf:/etc/mysql <span style=color:#b62;font-weight:700>\ </span>
</span></span><span style=display:flex><span>-e <span style=color:#b8860b>MYSQL_ROOT_PASSWORD</span><span style=color:#666>=</span>root  <span style=color:#b62;font-weight:700>\ </span>
</span></span><span style=display:flex><span>-d mysql:5.7 
</span></span></code></pre></div><h1 id=二redis集群>二、redis集群</h1><h2 id=1hash取余分区>1、hash取余分区</h2><p>2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式：</p><p>​ hash(key) % N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。</p><h3 id=1优点>1）<strong>优点</strong></h3><p>简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。</p><h3 id=2缺点>2）缺点</h3><p>原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/3会变成Hash(key) /?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。</p><p>某个redis机器宕机了，由于台数数量变化，会导致hash取余全部数据重新洗牌。</p><h2 id=2一致性hash算法分区>2、一致性hash算法分区</h2><p>一致性哈希算法在1997年由麻省理工学院中提出的，设计目标是为了解决</p><p>分布式缓存数据 变动和映射问题 ，某个机器宕机了，分母数量改变了，自然取余数不OK了。</p><p>提出一致性Hash解决方案。目的是当服务器个数发生变动时，尽量减少影响客户端到服务器的映射关系</p><h3 id=1一致性哈希环>1）一致性哈希环</h3><p>一致性哈希算法必然有个hash函数并按照算法产生hash值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个hash空间[0,2^32-1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连(0 = 2^32),这样让它逻辑上形成了一个环形空间。</p><p>它也是按照使用取模的方法，前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性Hash算法是对2^32取模，简单来说， 一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环 ，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希环如下图：整个空间 按顺时针方向组织 ，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4、……直到2^32-1，也就是说0点左侧的第一个点代表2^32-1， 0和2^32-1在零点中方向重合，我们把这个由2^32个点组成的圆环称为Hash环。</p><h3 id=2节点映射>2）节点映射</h3><p>将集群中各个IP节点映射到环上的某一个位置。</p><p>将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，经过IP地址的 哈希函数 计算(hash(ip))，使用IP地址哈希后在环空间的位置如下：</p><h3 id=3key落到服务器的落键规则>3）key落到服务器的落键规则</h3><p>当我们需要存储一个kv键值对时，首先计算key的hash值，hash(key)，将这个key使用相同的函数Hash计算出哈希值并确定此数据在环上的位置， 从此位置沿环顺时针“行走” ，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。</p><p>如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</p><p><strong>①优点</strong></p><p><strong>一致性哈希算法的容错性</strong></p><p>​ 假设Node C宕机，可以看到此时对象A、B、D不会受到影响，只有C对象被重定位到Node D。一般的，在一致性Hash算法中，如果一台服务器不可用，则 受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据 ，其它不会受到影响。简单说，就是C挂了，受到影响的只是B、C之间的数据，并且这些数据会转移到D进行存储。</p><p><strong>一致性哈希算法的扩展性</strong></p><p>​ 数据量增加了，需要增加一台节点NodeX，X的位置在A和B之间，那收到影响的也就是A到X之间的数据，重新把A到X的数据录入到X上即可， 不会导致hash取余全部数据重新洗牌。</p><p><strong>②缺点</strong></p><p>Hash环的数据倾斜问题</p><p>一致性Hash算法在服务 <strong>节点太少时</strong> ，容易因为节点分布不均匀而造成 <strong>数据倾斜</strong> （被缓存的对象大部分集中缓存在某一台服务器上）问题，</p><h2 id=3hash槽分区>3、hash槽分区</h2><h3 id=1-为什么出现>1） 为什么出现</h3><p>哈希槽实质就是一个数组，数组[0,2^14 -1]形成hash slot空间。 16384</p><h3 id=2-能干什么>2） 能干什么</h3><p>解决均匀分配的问题， 在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系 ，现在就相当于节点上放的是槽，槽里放的是数据。</p><p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。</p><p>哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配。</p><h3 id=3-多少个hash槽>3） 多少个hash槽</h3><p>一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。可以指定哪些编号的槽分配给哪个主节点。集群会记录节点和槽的对应关系。解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取余，余数是几key就落入对应的槽里。slot = CRC16(key) % 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p><p>为什么redis最大槽数是16384个？</p><h3 id=4-hash槽计算>4） hash槽计算</h3><p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVA data-lang=JAVA><span style=display:flex><span>SlotHash<span style=color:#666>.</span><span style=color:#b44>getSlot</span><span style=color:#666>(</span><span style=color:#b44>&#34;A&#34;</span><span style=color:#666>)</span> <span style=color:#080;font-style:italic>//6373
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>SlotHash<span style=color:#666>.</span><span style=color:#b44>getSlot</span><span style=color:#666>(</span><span style=color:#b44>&#34;B&#34;</span><span style=color:#666>)</span> <span style=color:#080;font-style:italic>//10374
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>SlotHash<span style=color:#666>.</span><span style=color:#b44>getSlot</span><span style=color:#666>(</span><span style=color:#b44>&#34;C&#34;</span><span style=color:#666>)</span>	<span style=color:#080;font-style:italic>//14503
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>SlotHash<span style=color:#666>.</span><span style=color:#b44>getSlot</span><span style=color:#666>(</span><span style=color:#b44>&#34;HELLO&#34;</span><span style=color:#666>)</span><span style=color:#080;font-style:italic>//866
</span></span></span></code></pre></div><h2 id=4redis集群>4、redis集群</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d --name redis-node-1 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-1:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6381</span> 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>docker run -d --name redis-node-2 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-2:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6382</span> 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>docker run -d --name redis-node-3 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-3:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6383</span> 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>docker run -d --name redis-node-4 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-4:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6384</span> 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>docker run -d --name redis-node-5 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-5:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6385</span> 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>docker run -d --name redis-node-6 --net host --privileged<span style=color:#666>=</span><span style=color:#a2f>true</span> -v /data/redis/share/redis-node-6:/data redis:6.0.8 --cluster-enabled yes --appendonly yes --port <span style=color:#666>6386</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--net host  					使用宿主机的IP和端口，默认
</span></span><span style=display:flex><span>--privileged<span style=color:#666>=</span><span style=color:#a2f>true</span>			获取宿主机root用户权限
</span></span><span style=display:flex><span>-v /data/redis/share/redis-node-6:/data  容器卷，宿主机地址:docker内部地址
</span></span><span style=display:flex><span>redis:6.0.8  					redis镜像和版本号
</span></span><span style=display:flex><span>--cluster-enabled yes	开启redis集群
</span></span><span style=display:flex><span>--appendonly yes			开启持久化
</span></span><span style=display:flex><span>--port 6386						redis端口号
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>redis-cli --cluster create 
</span></span><span style=display:flex><span>192.168.111.147:6381 
</span></span><span style=display:flex><span>192.168.111.147:6382 
</span></span><span style=display:flex><span>192.168.111.147:6383 
</span></span><span style=display:flex><span>192.168.111.147:6384 
</span></span><span style=display:flex><span>192.168.111.147:6385 
</span></span><span style=display:flex><span>192.168.111.147:6386 
</span></span><span style=display:flex><span>--cluster-replicas <span style=color:#666>1</span> 
</span></span></code></pre></div><h2 id=5数据读写存储>5、数据读写存储</h2><h3 id=1查看集群状态>1）查看集群状态</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>redis-cli -p <span style=color:#666>6381</span>
</span></span><span style=display:flex><span>cluster info
</span></span><span style=display:flex><span>cluster nodes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>set</span> k1 v1 分配槽时，分配到别的节点就会报错error
</span></span><span style=display:flex><span>redis-cli -p <span style=color:#666>6381</span> -c
</span></span></code></pre></div><p>另一种方法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis -cli --cluster check 192.168.111.167:6381
</span></span></code></pre></div><h3 id=2使用集群命令>2）使用集群命令</h3><h2 id=6容错切换迁移>6、容错切换迁移</h2><p>1号主节点宕机，4号从节点成为主节点。</p><p>1号主节点恢复，成为从节点。需要手动切换</p><h2 id=7主从扩容>7、主从扩容</h2><p>1）步骤</p><p>​ 新建两个节点，一主一从</p><p>​ 进入容器内部</p><p>​ 将新增的6387节点作为master节点加入原集群</p><p>​ 检查集群情况第1次</p><p>​ 重新分派槽号</p><p>​ 检查集群情况第2次</p><p>​ 为主节点6387分配从节点6388</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>命令：redis-cli  --cluster add-node  ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>redis-cli --cluster add-node 192.168.111.147:6388 192.168.111.147:6387 --cluster-slave --cluster-master-id e4781f644d4a4e4d4b4d107157b9ba8144631451-------这个是6387的编号，按照自己实际情况 
</span></span></code></pre></div><p>​ 检查集群情况第3次</p><p>2）重新分配槽位</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis cli -- cluster reshard 192.168.111.117:6381
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>how many slots  do you want to move (from 1 to 16384)? 4096
</span></span><span style=display:flex><span>what is the receiving node ID? 新加节点的id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>redis -cli --cluster check 192.168.111.167:6381
</span></span></code></pre></div><p>每个节点平均给新节点分配了一点槽位</p><h2 id=8主从缩容>8、主从缩容</h2><p>目的：6387和6388下线</p><p>检查集群情况1获得6388的节点ID</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-cli --cluster check 192.168.111.147:6382 
</span></span></code></pre></div><p>将6388删除，从集群中将4号从节点6388删除</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>命令：redis-cli --cluster  del-node  ip:从机端口 从机6388节点ID
</span></span><span style=display:flex><span>redis-cli --cluster  del-node  192.168.111.147:6388 5d149074b7e57b802287d1797a874ed7a1a284a8 
</span></span></code></pre></div><p>将6387的槽号清空，重新分配，本例将清出来的槽号都给6381</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>how many slots  do you want to move (from 1 to 16384)? 4096
</span></span><span style=display:flex><span>what is the receiving node ID? 新加节点的id  6381
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source node #1: 要删除的master
</span></span><span style=display:flex><span>source node #2: done
</span></span></code></pre></div><p>检查集群情况第二次</p><p>将6387删除</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-cli --cluster  del-node  192.168.111.147:6388 5d149074b7e57b802287d1797a874ed7a1a284a8 
</span></span></code></pre></div><p>检查集群情况第三次</p></div><footer class=post-footer><div class=post-tags><a href=/tags/docker rel=tag title=docker>#docker#</a>
<a href=/tags/%e5%ae%b9%e5%99%a8%e5%8c%96%e6%8a%80%e6%9c%af rel=tag title=容器化技术>#容器化技术#</a>
<a href=/tags/%e9%9b%86%e7%be%a4 rel=tag title=集群>#集群#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>docker（二）集群</p><p><span>链接：</span>https://zhang4014439175.github.io/post/docker%E4%B8%89%E5%AE%89%E8%A3%85mysql%E5%92%8Credis%E9%9B%86%E7%BE%A4/</p><p><span>作者：</span>keepmovinggg</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://zhang4014439175.github.io/post/docker%E4%BA%8C/ rel=next title=docker（二）镜像><i class="fa fa-chevron-left"></i> docker（二）镜像</a></div><div class="post-nav-prev post-nav-item"><a href=https://zhang4014439175.github.io/post/docker%E4%B8%80/ rel=prev title=docker（一）基础>docker（一）基础
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=keepmovinggg><p class=site-author-name itemprop=name>keepmovinggg</p><p class="site-description motion-element" itemprop=description>再平凡的人也有属于他自己的梦想!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>29</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>33</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/zhang4014439175 target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://stackoverflow.com/users/17131342/git-zhangzm target=_blank title=StackOverFlow><i class="fa fa-fw fa-globe"></i>
StackOverFlow</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title target=_blank></a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>15</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/spring>Spring
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%A1%86%E6%9E%B6>框架
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/sql>SQL
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF>容器化技术
<sup>4</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/jvm>Jvm
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mybatis>Mybatis
<sup>2</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/rabbitmq>Rabbitmq
<sup>2</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>换个方向前进</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.96.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://www.ucloud.cn/ style=font-weight:700 target=_blank>UCloud云存储</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>粤ICP备18047355号</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/search.js></script>
<script type=text/javascript src=https://zhang4014439175.github.iojs/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var t=$(".header-inner").height()+10,n,s,e,o;$("#sidebar").css({'margin-top':t}).show(),n=parseInt($("#sidebar").css("margin-top")),s=parseInt($(".sidebar-inner").css("height")),e=n+s,o=$(".content-wrap").height(),o<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var e=document.createElement("script"),t,n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>